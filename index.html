<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAlvRBErv2pG8BObnX8Ew0CqOQKypTM39c",
        authDomain: "controle-612f2.firebaseapp.com",
        projectId: "controle-612f2",
        storageBucket: "controle-612f2.firebasestorage.app",
        messagingSenderId: "39791655795",
        appId: "1:39791655795:web:1b6ad76afa568af3b86306",
        measurementId: "G-7X9S01NMWX",
        databaseURL: "https://controle-612f2-default-rtdb.firebaseio.com/"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      const provider = new GoogleAuthProvider();

      window.firebaseSDK = { auth, database, provider, signInWithPopup, signOut, onAuthStateChanged, ref, set, get };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transaction-type-btn { border-width: 1px; padding: 0.5rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .transaction-type-btn.active { color: white; }
        .transaction-type-btn[data-type="entrada"].active { background-color: #22c55e; border-color: #22c55e; }
        .transaction-type-btn[data-type="saida"].active { background-color: #ef4444; border-color: #ef4444; }
        .transaction-type-btn[data-type="investimento"].active { background-color: #3b82f6; border-color: #3b82f6; }
        .value-hidden { filter: blur(5px); transition: filter 0.3s ease; }
        .value-visible { filter: blur(0); transition: filter 0.3s ease; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #f3f4f6; }
        .sortable-header .sort-icon { display: inline-block; margin-left: 4px; opacity: 0.5; transition: opacity 0.2s, transform 0.2s; }
        .sortable-header.asc .sort-icon { opacity: 1; transform: rotate(0deg); }
        .sortable-header.desc .sort-icon { opacity: 1; transform: rotate(180deg); }
        #transactions-modal-list tr[data-id], #debt-list-container tr[data-id] { cursor: pointer; }
        .invalid-field { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444 !important; }
        .category-item summary::-webkit-details-marker, .type-item summary::-webkit-details-marker { display: none; }
        .category-item summary, .type-item summary { list-style: none; }
        .type-item[open] > summary .details-arrow, .category-item[open] > summary .details-arrow { transform: rotate(180deg); }
        .details-arrow { transition: transform 0.2s; }
        .filter-type-btn { padding: 0.25rem 0.75rem; border: 1px solid #d1d5db; background-color: white; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .filter-type-btn:first-child { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
        .filter-type-btn:last-child { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; }
        .filter-type-btn + .filter-type-btn { border-left-width: 0; }
        .filter-type-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; z-index: 10; }
        .budget-bar-container:hover { background-color: #f9fafb; }
        #ai-result-state { line-height: 1.7; }
        #ai-result-state h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        #ai-result-state ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; }
        #ai-result-state strong { font-weight: 600; }
        .installment-paid { text-decoration: line-through; color: #9ca3af; }
        .amortization-radio-label { border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; }
        .amortization-radio-label:has(input:checked) { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Controle Financeiro</h1>
            <p class="text-gray-600 mb-6">Acesse seus dados de qualquer lugar.</p>
            <button id="login-btn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center mx-auto">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,36.148,44,30.638,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Entrar com Google
            </button>
        </div>
    </div>
    
    <div id="app" class="container mx-auto p-4 md:p-6 hidden">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Painel Financeiro</h1>
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-3">
                    <span id="user-display" class="text-sm text-gray-600 hidden md:block"></span>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 text-sm font-semibold px-4 py-2 rounded-md hover:bg-gray-300">Sair</button>
                </div>
                <div class="h-8 border-l border-gray-300 mx-2"></div>
                <button id="ai-btn" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200" title="Análise com IA"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></button>
                <button id="forecast-btn" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200" title="Previsão Futura"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></button>
                <button id="settings-btn" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200" title="Configurações"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
            </div>
        </header>
        
        <main class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div data-card-type="balance" class="bg-white p-5 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 font-medium">Saldo</h3><p id="balance-value" class="text-2xl font-bold text-gray-800 value-visible">R$ 0,00</p></div><button class="toggle-visibility-btn text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button></div></div>
                <div data-card-type="debts" class="bg-white p-5 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 font-medium">Dívidas</h3><p id="debts-value" class="text-2xl font-bold text-gray-800 value-visible">R$ 0,00</p></div><button class="toggle-visibility-btn text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button></div></div>
                <div data-card-type="investments" class="bg-white p-5 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"><div class="flex justify-between items-start"><div><h3 class="text-gray-500 font-medium">Total Investido</h3><p id="investments-value" class="text-2xl font-bold text-gray-800 value-visible">R$ 0,00</p></div><button class="toggle-visibility-btn text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button></div></div>
                <div data-card-type="invoice" class="bg-white p-5 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <h3 class="text-gray-500 font-medium">Fatura</h3>
                                <button id="prev-invoice-btn" class="p-1 rounded-full hover:bg-gray-200 text-gray-500 hover:text-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                <span id="invoice-period-display" class="text-sm font-semibold text-gray-700 w-24 text-center"></span>
                                <button id="next-invoice-btn" class="p-1 rounded-full hover:bg-gray-200 text-gray-500 hover:text-gray-800"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                            </div>
                            <p id="invoice-value" class="text-2xl font-bold text-gray-800 value-visible">R$ 0,00</p>
                        </div>
                        <button class="toggle-visibility-btn text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                    </div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-semibold text-gray-800">Visão Geral do Mês</h3>
                         <div class="flex items-center space-x-2">
                            <button id="prev-month-btn" class="p-1 rounded-full hover:bg-gray-200"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                            <span id="pending-month-display" class="font-semibold text-gray-700 w-32 text-center"></span>
                            <button id="next-month-btn" class="p-1 rounded-full hover:bg-gray-200"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="view-pending-btn" class="relative text-sm font-semibold text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 px-3 py-1.5 rounded-md hidden">
                            Ver Pendentes
                            <span id="pending-count-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                        <button class="toggle-visibility-btn text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                    <div id="overview-income-card" class="p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                        <p class="text-sm text-gray-500">Entradas</p>
                        <p id="overview-income" class="text-xl font-bold text-green-600 value-visible">R$ 0,00</p>
                        <p id="overview-income-pending" class="text-xs text-gray-500 value-visible h-4"></p>
                    </div>
                    <div id="overview-expenses-card" class="p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                        <p class="text-sm text-gray-500">Saídas</p>
                        <p id="overview-expenses" class="text-xl font-bold text-red-600 value-visible">R$ 0,00</p>
                        <p id="overview-expenses-pending" class="text-xs text-gray-500 value-visible h-4"></p>
                    </div>
                    <div id="overview-balance-card" class="p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                        <p class="text-sm text-gray-500">Saldo do Mês</p>
                        <p id="overview-balance" class="text-xl font-bold text-blue-600 value-visible">R$ 0,00</p>
                        <div class="h-4"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                    <div class="md:col-span-1 h-56 mx-auto"><canvas id="category-chart"></canvas></div>
                    <div id="budget-bars-container" class="md:col-span-2 space-y-4"></div>
                </div>
            </div>
        </main>
        <button id="add-transaction-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 z-40"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
        <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto" role="dialog"><div class="flex justify-between items-center mb-4"><h2 id="modal-headline" class="text-xl font-bold text-gray-800">Nova Transação</h2><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button></div><form id="transaction-form" novalidate><div class="mb-4"><span class="block text-sm font-medium text-gray-700 mb-2">Tipo</span><div id="transaction-type-container" class="grid grid-cols-3 gap-2"><div data-type="entrada" class="transaction-type-btn border-green-500 text-green-500 hover:bg-green-50 text-center">Entrada</div><div data-type="saida" class="transaction-type-btn border-red-500 text-red-500 hover:bg-red-50 text-center">Saída</div><div data-type="investimento" class="transaction-type-btn border-blue-500 text-blue-500 hover:bg-blue-50 text-center">Investimento</div></div></div>
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
                <div class="flex items-center"><input id="is-fixed" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="is-fixed" class="ml-2 block text-sm text-gray-900">Transação Recorrente</label></div>
                <div id="is-variable-container" class="flex items-center hidden"><input id="is-variable" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="is-variable" class="ml-2 block text-sm text-gray-900">Valor Variável</label></div>
                <div id="recurrence-period-container" class="hidden"><select id="recurrence-period" class="block w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"><option value="monthly">Mensal</option><option value="daily">Diária</option><option value="weekly">Semanal</option><option value="yearly">Anual</option></select></div>
                <div id="recurrence-count-container" class="hidden"><input type="number" id="recurrence-count" min="1" placeholder="Nº de repetições" class="w-32 border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4"><div><label for="amount" class="block text-sm font-medium text-gray-700">Valor</label><input type="number" id="amount" name="amount" step="0.01" placeholder="R$ 0,00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><div><label for="date" class="block text-sm font-medium text-gray-700">Data da 1ª Ocorrência</label><input type="date" id="date" name="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="category" class="block text-sm font-medium text-gray-700">Categoria</label><select id="category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><option value="">Selecione</option></select></div><div><label for="subcategory" class="block text-sm font-medium text-gray-700">Subcategoria</label><select id="subcategory" name="subcategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><option value="">Selecione</option></select></div></div><div id="payment-method-container" class="mb-4"><label for="payment-method" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label><select id="payment-method" name="payment-method" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><option value="">Selecione</option><option>Cartão de Crédito</option><option>Cartão de Débito</option><option>Dinheiro</option><option>PIX</option><option>Transferência Bancária</option></select></div><div class="mb-6"><label for="description" class="block text-sm font-medium text-gray-700">Descrição</label><textarea id="description" name="description" rows="2" placeholder="Ex: Compras no supermercado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea></div><div id="form-error-message" class="hidden text-red-600 text-sm mb-4 p-3 bg-red-100 rounded-md text-center"></div><button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md hover:bg-blue-700">Adicionar Transação</button></form></div>
        </div>
        <div id="transactions-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-auto max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 id="transactions-modal-title" class="text-xl font-bold text-gray-800">Detalhes</h2>
                    <div class="flex items-center space-x-3">
                        <button id="export-btn" class="hidden bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 text-sm font-semibold flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>Exportar XLSX</span></button>
                        <button id="close-transactions-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                </div>
                <div id="transactions-modal-filters" class="mb-4"></div>
                <div id="transactions-modal-list" class="overflow-y-auto flex-grow"></div>
                <div id="transactions-modal-footer" class="mt-4 pt-4 border-t flex justify-end space-x-6 text-right hidden">
                    <div>
                        <p class="text-sm text-gray-500">Total do Período</p>
                        <p id="modal-total-period" class="text-lg font-bold"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Filtrado</p>
                        <p id="modal-total-filtered" class="text-lg font-bold"></p>
                    </div>
                </div>
            </div>
        </div>
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xl font-bold text-gray-800">Configurações</h2><button id="close-settings-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><form id="settings-form" class="flex-grow overflow-y-auto pr-2 space-y-6"><div class="p-4 border rounded-md"><h3 class="text-lg font-semibold text-gray-700 mb-3">Geral</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="invoice-closing-day" class="block text-sm font-medium text-gray-700">Dia de Fechamento do Cartão</label><input type="number" id="invoice-closing-day" name="invoice-closing-day" min="1" max="31" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><div><label for="savings-goal" class="block text-sm font-medium text-gray-700">Meta de Economia Mensal</label><input type="number" id="savings-goal" name="savings-goal" step="0.01" placeholder="R$ 0,00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div></div></div><div class="p-4 border rounded-md"><h3 class="text-lg font-semibold text-gray-700 mb-3">Gerenciar Categorias e Orçamentos</h3><p class="text-sm text-gray-500 mb-4">Defina orçamentos e gerencie suas categorias e subcategorias.</p><div id="category-management-container" class="space-y-2"></div></div><div class="p-4 border rounded-md"><h3 class="text-lg font-semibold text-gray-700 mb-3">Importar & Exportar Dados</h3><p class="text-sm text-gray-500 mb-4">Faça backup ou restaure seus dados.</p><div class="grid grid-cols-1 md:grid-cols-3 gap-3"><button id="download-template-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-semibold text-sm">Baixar Modelo</button><button id="export-all-btn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold text-sm">Exportar Tudo</button><button id="import-all-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold text-sm">Importar Dados</button></div><input type="file" id="import-file-input" class="hidden" accept=".xlsx"></div></form><div class="mt-6 pt-4 border-t"><button type="submit" form="settings-form" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md hover:bg-blue-700">Salvar Alterações</button></div></div></div>
        <div id="forecast-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-auto max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xl font-bold text-gray-800">Previsão Futura</h2><div class="flex items-center space-x-3"><button id="export-forecast-btn" class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 text-sm font-semibold flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>Exportar XLSX</span></button><button id="close-forecast-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div></div><div class="overflow-y-auto flex-grow"><div class="mb-6 p-4 bg-gray-50 rounded-lg border"><h3 class="text-lg font-semibold text-gray-700 mb-3">Médias Mensais Projetadas</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><p class="text-sm text-gray-500">Renda Média</p><p id="forecast-avg-income" class="text-xl font-bold text-green-600">R$ 0,00</p></div><div><p class="text-sm text-gray-500">Despesa Média</p><p id="forecast-avg-expense" class="text-xl font-bold text-red-600">R$ 0,00</p></div><div><p class="text-sm text-gray-500">Investimento Médio</p><p id="forecast-avg-investment" class="text-xl font-bold text-blue-600">R$ 0,00</p></div><div><p class="text-sm text-gray-500">Saldo Médio</p><p id="forecast-avg-balance" class="text-xl font-bold text-gray-800">R$ 0,00</p></div></div></div><div><h3 class="text-lg font-semibold text-gray-700 mb-3">Projeção de Saldo para os Próximos 12 Meses</h3><div class="h-80"><canvas id="forecast-chart"></canvas></div></div></div></div></div>
        <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xl font-bold text-gray-800">Análise Inteligente</h2><button id="close-ai-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="ai-content" class="overflow-y-auto flex-grow p-2"><div id="ai-initial-state"><div class="text-center p-6"><svg class="w-16 h-16 mx-auto text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg><h3 class="mt-4 text-lg font-medium text-gray-900">Insights para suas Finanças</h3><p class="mt-2 text-sm text-gray-500">Receba dicas personalizadas. A IA analisará anonimamente seus dados dos últimos 3 meses.</p><button id="analyze-finance-btn" class="mt-6 w-full bg-purple-600 text-white py-2.5 px-4 rounded-md hover:bg-purple-700">Analisar minhas finanças</button></div></div><div id="ai-loading-state" class="hidden text-center p-10"><svg class="animate-spin h-8 w-8 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-gray-600 font-medium">Analisando seus dados...</p></div><div id="ai-result-state" class="hidden"></div></div></div></div>
        <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto"><h3 id="generic-modal-title" class="text-lg font-bold text-gray-800 mb-4"></h3><p id="generic-modal-message" class="text-gray-600 mb-6"></p><div id="generic-modal-input-container" class="hidden mb-4"><input type="text" id="generic-modal-input" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><div id="generic-modal-buttons" class="flex justify-end space-x-3"></div></div></div>
        <div id="debt-management-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-auto max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xl font-bold text-gray-800">Gerenciar Dívidas</h2><button id="close-debt-management-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div id="debt-list-container" class="overflow-y-auto flex-grow mb-4"></div><div class="pt-4 border-t"><button id="add-new-debt-btn" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md hover:bg-blue-700 font-semibold">+ Adicionar Nova Dívida</button></div></div></div>
        <div id="add-edit-debt-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-60 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto"><div class="flex justify-between items-center mb-4"><h2 id="add-edit-debt-modal-title" class="text-xl font-bold text-gray-800">Nova Dívida</h2><button id="close-add-edit-debt-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button></div><form id="debt-form" novalidate class="space-y-4"><div><label for="debt-description" class="block text-sm font-medium text-gray-700">Descrição</label><input type="text" id="debt-description" placeholder="Ex: Financiamento do Carro" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div class="grid grid-cols-2 gap-4"><div><label for="debt-total-amount" class="block text-sm font-medium text-gray-700">Valor Total da Dívida</label><input type="number" id="debt-total-amount" step="0.01" placeholder="R$ 10.000,00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="debt-down-payment" class="block text-sm font-medium text-gray-700">Valor de Entrada (Opcional)</label><input type="number" id="debt-down-payment" step="0.01" placeholder="R$ 2.000,00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="debt-installments-count" class="block text-sm font-medium text-gray-700">Nº de Parcelas</label><input type="number" id="debt-installments-count" step="1" placeholder="12" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="debt-start-date" class="block text-sm font-medium text-gray-700">Data da 1ª Parcela</label><input type="date" id="debt-start-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div></div><div class="grid grid-cols-2 gap-4"><div><label for="debt-interest-rate" class="block text-sm font-medium text-gray-700">Taxa de Juros (%)</label><input type="number" id="debt-interest-rate" step="0.01" placeholder="1.99" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="debt-interest-period" class="block text-sm font-medium text-gray-700">Período do Juro</label><select id="debt-interest-period" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option value="monthly">Ao Mês</option><option value="yearly">Ao Ano</option></select></div></div><div><span class="block text-sm font-medium text-gray-700 mb-2">Sistema de Amortização</span><div class="flex items-center gap-4"><label class="amortization-radio-label"><input type="radio" name="amortization-type" value="PRICE" class="sr-only" checked> Tabela PRICE</label><label class="amortization-radio-label"><input type="radio" name="amortization-type" value="SAC" class="sr-only"> Sistema SAC</label></div></div><div id="debt-form-error-message" class="hidden text-red-600 text-sm mb-4 p-3 bg-red-100 rounded-md text-center"></div><div class="pt-4"><button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md hover:bg-blue-700 font-semibold">Salvar Dívida</button></div></form></div></div>
        <div id="debt-details-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-60 p-4"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl mx-auto max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 id="debt-details-modal-title" class="text-xl font-bold text-gray-800">Detalhes da Dívida</h2><button id="close-debt-details-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="overflow-y-auto flex-grow space-y-6"><div id="debt-summary-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center p-4 bg-gray-50 rounded-lg"></div><div class="p-4 border rounded-lg"><h3 class="text-lg font-semibold text-gray-700 mb-3">Adiantar Pagamento / Simulação</h3><div class="flex flex-wrap items-end gap-4"><div><label for="prepayment-amount" class="block text-sm font-medium text-gray-700">Valor a Adiantar</label><input type="number" id="prepayment-amount" step="0.01" placeholder="R$ 1.000,00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div><label for="prepayment-strategy" class="block text-sm font-medium text-gray-700">Estratégia</label><select id="prepayment-strategy" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="reduce_term">Reduzir Prazo</option><option value="reduce_installment">Reduzir Valor da Parcela</option></select></div><div class="flex items-center gap-2"><button id="simulate-prepayment-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-semibold text-sm">Simular</button><button id="confirm-prepayment-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold text-sm">Confirmar</button></div></div><div id="prepayment-simulation-result" class="mt-3 text-sm text-gray-700 bg-blue-50 p-3 rounded-md hidden"></div></div><div><h3 class="text-lg font-semibold text-gray-700 mb-2">Tabela de Amortização</h3><div id="debt-amortization-table-container" class="overflow-auto border rounded-lg"></div></div></div></div></div>

        <div id="pending-transactions-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 id="pending-modal-title" class="text-xl font-bold text-gray-800">Transações Pendentes</h2>
                    <button id="close-pending-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="pending-modal-list" class="overflow-y-auto flex-grow">
                </div>
            </div>
        </div>

    </div>

    <script>
    // SCRIPT COMPLETO COM TODAS AS CORREÇÕES E FUNCIONALIDADES
    document.addEventListener('DOMContentLoaded', () => {
        const { auth, database, provider, signInWithPopup, signOut, onAuthStateChanged, ref, set, get } = window.firebaseSDK;
        const loginScreen = document.getElementById('login-screen');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const appContainer = document.getElementById('app');
        const userDisplay = document.getElementById('user-display');
        
        let currentUser = null;

        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionModal = document.getElementById('transaction-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const transactionForm = document.getElementById('transaction-form');
        const transactionTypeBtns = document.querySelectorAll('.transaction-type-btn');
        const isFixedCheckbox = document.getElementById('is-fixed');
        const isVariableContainer = document.getElementById('is-variable-container');
        const recurrencePeriodContainer = document.getElementById('recurrence-period-container');
        const recurrenceCountContainer = document.getElementById('recurrence-count-container');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const paymentMethodContainer = document.getElementById('payment-method-container');
        const paymentMethodSelect = document.getElementById('payment-method');
        const formErrorMessage = document.getElementById('form-error-message');
        const balanceValueEl = document.getElementById('balance-value');
        const debtsValueEl = document.getElementById('debts-value');
        const investmentsValueEl = document.getElementById('investments-value');
        const invoiceValueEl = document.getElementById('invoice-value');
        const prevInvoiceBtn = document.getElementById('prev-invoice-btn');
        const nextInvoiceBtn = document.getElementById('next-invoice-btn');
        const invoicePeriodDisplay = document.getElementById('invoice-period-display');
        const toggleVisibilityBtns = document.querySelectorAll('.toggle-visibility-btn');
        const valueElements = document.querySelectorAll('[id$="-value"], .value-visible');
        const transactionsModal = document.getElementById('transactions-modal');
        const closeTransactionsModalBtn = document.getElementById('close-transactions-modal-btn');
        const transactionsModalTitle = document.getElementById('transactions-modal-title');
        const transactionsModalFilters = document.getElementById('transactions-modal-filters');
        const transactionsModalList = document.getElementById('transactions-modal-list');
        const exportBtn = document.getElementById('export-btn');
        const cards = document.querySelectorAll('[data-card-type]');
        
        const viewPendingBtn = document.getElementById('view-pending-btn');
        const pendingCountBadge = document.getElementById('pending-count-badge');
        const pendingTransactionsModal = document.getElementById('pending-transactions-modal');
        const closePendingModalBtn = document.getElementById('close-pending-modal-btn');
        const pendingModalList = document.getElementById('pending-modal-list');
        const pendingModalTitle = document.getElementById('pending-modal-title');

        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const pendingMonthDisplay = document.getElementById('pending-month-display');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
        const settingsForm = document.getElementById('settings-form');
        const categoryManagementContainer = document.getElementById('category-management-container');
        const invoiceClosingDayInput = document.getElementById('invoice-closing-day');
        const savingsGoalInput = document.getElementById('savings-goal');
        const downloadTemplateBtn = document.getElementById('download-template-btn');
        const exportAllBtn = document.getElementById('export-all-btn');
        const importAllBtn = document.getElementById('import-all-btn');
        const importFileInput = document.getElementById('import-file-input');
        const forecastBtn = document.getElementById('forecast-btn');
        const forecastModal = document.getElementById('forecast-modal');
        const closeForecastModalBtn = document.getElementById('close-forecast-modal-btn');
        const exportForecastBtn = document.getElementById('export-forecast-btn');
        const forecastChartCanvas = document.getElementById('forecast-chart');
        const aiBtn = document.getElementById('ai-btn');
        const aiModal = document.getElementById('ai-modal');
        const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
        const analyzeFinanceBtn = document.getElementById('analyze-finance-btn');
        const aiInitialState = document.getElementById('ai-initial-state');
        const aiLoadingState = document.getElementById('ai-loading-state');
        const aiResultState = document.getElementById('ai-result-state');
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalMessage = document.getElementById('generic-modal-message');
        const genericModalInputContainer = document.getElementById('generic-modal-input-container');
        const genericModalInput = document.getElementById('generic-modal-input');
        const genericModalButtons = document.getElementById('generic-modal-buttons');
        const debtManagementModal = document.getElementById('debt-management-modal');
        const closeDebtManagementModalBtn = document.getElementById('close-debt-management-modal-btn');
        const debtListContainer = document.getElementById('debt-list-container');
        const addNewDebtBtn = document.getElementById('add-new-debt-btn');
        const addEditDebtModal = document.getElementById('add-edit-debt-modal');
        const closeAddEditDebtModalBtn = document.getElementById('close-add-edit-debt-modal-btn');
        const addEditDebtModalTitle = document.getElementById('add-edit-debt-modal-title');
        const debtForm = document.getElementById('debt-form');
        const debtFormErrorMessage = document.getElementById('debt-form-error-message');
        const debtDetailsModal = document.getElementById('debt-details-modal');
        const closeDebtDetailsModalBtn = document.getElementById('close-debt-details-modal-btn');
        const debtDetailsModalTitle = document.getElementById('debt-details-modal-title');
        const debtSummaryContainer = document.getElementById('debt-summary-container');
        const debtAmortizationTableContainer = document.getElementById('debt-amortization-table-container');
        const simulatePrepaymentBtn = document.getElementById('simulate-prepayment-btn');
        const confirmPrepaymentBtn = document.getElementById('confirm-prepayment-btn');
        const prepaymentSimulationResult = document.getElementById('prepayment-simulation-result');
        const overviewIncomeEl = document.getElementById('overview-income');
        const overviewExpensesEl = document.getElementById('overview-expenses');
        const overviewBalanceEl = document.getElementById('overview-balance');
        const overviewIncomePendingEl = document.getElementById('overview-income-pending');
        const overviewExpensesPendingEl = document.getElementById('overview-expenses-pending');
        const categoryChartCanvas = document.getElementById('category-chart');
        const budgetBarsContainer = document.getElementById('budget-bars-container');

        const overviewIncomeCard = document.getElementById('overview-income-card');
        const overviewExpensesCard = document.getElementById('overview-expenses-card');
        const overviewBalanceCard = document.getElementById('overview-balance-card');

        let transactions = [];
        let fixedTransactionTemplates = [];
        let debts = [];
        let currentPendingDate = new Date();
        let invoiceMonthOffset = 0; 
        let selectedTransactionType = null;
        let areValuesVisible = true;
        let currentSort = { key: 'date', direction: 'desc' };
        let modalTransactionData = [];
        let currentFilteredModalData = [];
        let activeFilters = { type: 'all', category: 'all', startDate: '', endDate: '' };
        let categoryChartInstance = null;
        let forecastChartInstance = null;
        let forecastDataForExport = [];
        let editingTransactionId = null;
        let editingDebtId = null;
        let viewingDebtId = null;
        
        const defaultSettings = { invoiceClosingDay: 1, savingsGoal: 0, budgets: {} };
        const defaultCategories = {
            'entrada': { 'Salário': ['Adiantamento', 'Salário Mensal', 'Bônus', 'Férias'],'Investimentos': ['Dividendos', 'Venda de Ativos', 'Juros'],'Outras Receitas': ['Freelance', 'Vendas', 'Presente', 'Reembolso']},
            'saida': {'Alimentação': ['Supermercado', 'Restaurante', 'Delivery', 'Lanche'],'Moradia': ['Aluguel', 'Condomínio', 'Luz', 'Água', 'Internet', 'Gás', 'Manutenção'],'Transporte': ['Combustível', 'App de Transporte', 'Transporte Público', 'Manutenção Veículo'],'Lazer': ['Cinema', 'Shows', 'Viagens', 'Hobbies', 'Streaming'],'Saúde': ['Farmácia', 'Consulta', 'Plano de Saúde', 'Academia'],'Educação': ['Cursos', 'Livros', 'Mensalidade'],'Compras': ['Roupas', 'Eletrônicos', 'Casa', 'Pets'],'Dívidas': ['Parcela Empréstimo', 'Parcela Financiamento', 'Entrada Financiamento'],'Outras Despesas': ['Impostos', 'Presentes', 'Doações', 'Serviços']},
            'investimento': {'Renda Fixa': ['CDB', 'Tesouro Direto', 'LCI/LCA'],'Renda Variável': ['Ações', 'Fundos Imobiliários', 'ETFs'],'Outros': ['Criptomoedas', 'Previdência Privada']}
        };
        
        let settings = { ...defaultSettings };
        let categoryData = { ...defaultCategories };
        
        const saveData = async () => {
            if (!currentUser) return;
            const dataToSave = { transactions, fixedTransactionTemplates, debts, settings, categoryData };
            try { await set(ref(database, 'users/' + currentUser.uid), dataToSave); } 
            catch (error) { console.error("Firebase save error:", error); showGenericModal({type: 'alert', title: 'Erro de Sincronização', message: 'Não foi possível salvar seus dados.'}); }
        };
        
        const loadData = async () => {
            if (!currentUser) return;
            const dataRef = ref(database, 'users/' + currentUser.uid);
            try {
                const snapshot = await get(dataRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    transactions = data.transactions || [];
                    fixedTransactionTemplates = data.fixedTransactionTemplates || [];
                    debts = data.debts || [];
                    settings = { ...defaultSettings, ...(data.settings || {}) };
                    settings.budgets = settings.budgets || {}; 
                    categoryData = data.categoryData || { ...defaultCategories };
                } else {
                    await saveData(); 
                }
            } catch (error) {
                console.error("Firebase load error:", error);
                showGenericModal({type: 'alert', title: 'Erro ao Carregar', message: 'Não foi possível carregar seus dados.'});
            }
            updateDashboard();
        };
        
        const handleLogin = () => { signInWithPopup(auth, provider).catch((error) => console.error("Login failed:", error)); };
        const handleLogout = () => { signOut(auth).catch((error) => console.error("Logout failed:", error)); };
        
        const resetAppState = () => {
                 transactions = []; fixedTransactionTemplates = []; debts = [];
                 settings = { ...defaultSettings }; categoryData = { ...defaultCategories };
                 if (appContainer.classList.contains('hidden')) return;
                 updateDashboard();
        };
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userDisplay.textContent = `Olá, ${user.displayName.split(' ')[0]}`;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadData().then(() => {
                    toggleValuesVisibility();
                });
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                resetAppState();
            }
        });
        
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR');

        const renderPendingModalList = () => {
            const monthName = currentPendingDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            pendingModalTitle.textContent = `Pendentes de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;

            const currentMonth = currentPendingDate.getMonth();
            const currentYear = currentPendingDate.getFullYear();
            const pendingTransactionsThisMonth = transactions.filter(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                return t.status === 'pending' && tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (pendingTransactionsThisMonth.length === 0) {
                pendingModalList.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Nenhuma transação pendente para este mês.</p>';
                return;
            }

            let html = '<div class="space-y-2">' + pendingTransactionsThisMonth.map(t => {
                const isDebtPayment = t.debtId;
                const amountField = t.isVariable && !isDebtPayment
                    ? `<input type="number" step="0.01" data-amount-input-id="${t.id}" value="${t.amount.toFixed(2)}" class="w-28 border border-gray-300 rounded-md py-1 px-2 text-sm text-right font-semibold text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-500">`
                    : `<p class="font-semibold text-gray-800 text-sm">${formatCurrency(t.amount)}</p>`;
                
                return `<div class="flex items-center justify-between p-2.5 bg-gray-50 rounded-lg border space-x-3">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-800 text-sm truncate" title="${t.description || 'Transação Recorrente'}">${t.description || 'Transação Recorrente'}</p>
                                <p class="text-xs text-gray-500">${formatDate(t.date)}
                                    ${t.isVariable ? '<span class="text-xs font-semibold bg-blue-100 text-blue-800 py-0.5 px-1 rounded-full ml-1.5">Variável</span>' : ''}
                                    ${isDebtPayment ? `<span class="text-xs font-semibold bg-orange-100 text-orange-800 py-0.5 px-1 rounded-full ml-1.5">Dívida ${t.installmentNumber}/${t.installmentsTotal}</span>` : ''}
                                </p>
                            </div>
                            <div class="flex-shrink-0">${amountField}</div>
                            <div class="flex-shrink-0 flex items-center space-x-1">
                                <button data-action="approve" data-id="${t.id}" title="Aprovar" class="p-1.5 text-green-600 hover:bg-green-100 rounded-full"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                                <button data-action="delete" data-id="${t.id}" title="Excluir" class="p-1.5 text-red-600 hover:bg-red-100 rounded-full"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                            </div>
                        </div>`;
            }).join('') + '</div>';
            pendingModalList.innerHTML = html;
        };
        
        const getInvoicePeriod = (offset = 0) => {
            const closingDay = settings.invoiceClosingDay || 1;
            const now = new Date();
            now.setMonth(now.getMonth() + offset);

            let closingDate = new Date(now.getFullYear(), now.getMonth(), closingDay);
            if (now.getDate() > closingDay) {
                closingDate.setMonth(closingDate.getMonth() + 1);
            }

            let startDate = new Date(closingDate.getFullYear(), closingDate.getMonth() - 1, closingDay + 1);
            let endDate = new Date(closingDate.getFullYear(), closingDate.getMonth(), closingDay);
            
            return { startDate, endDate };
        };
        
        const updateDashboard = () => {
            const completedTransactions = transactions.filter(t => t.status === 'completed');
            const totalEntradas = completedTransactions.filter(t => t.type === 'entrada').reduce((acc, t) => acc + t.amount, 0);
            const totalSaidas = completedTransactions.filter(t => t.type === 'saida' || t.type === 'investimento').reduce((acc, t) => acc + t.amount, 0);
            const totalInvestido = completedTransactions.filter(t => t.type === 'investimento').reduce((acc, t) => acc + t.amount, 0);
            const totalDebtBalance = debts.reduce((sum, debt) => debt.installments.filter(p => p.status === 'pending').reduce((s, p) => s + p.principal, 0) + sum, 0);
            
            const { startDate, endDate } = getInvoicePeriod(invoiceMonthOffset);
            invoicePeriodDisplay.textContent = endDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }).toUpperCase();
            prevInvoiceBtn.disabled = invoiceMonthOffset === 0;

            const faturaAtual = completedTransactions.filter(t => {
                if (t['payment-method'] !== 'Cartão de Crédito') return false;
                const tDate = new Date(t.date + 'T00:00:00');
                return tDate >= startDate && tDate <= endDate;
            }).reduce((acc, t) => acc + t.amount, 0);
            
            balanceValueEl.textContent = formatCurrency(totalEntradas - totalSaidas);
            investmentsValueEl.textContent = formatCurrency(totalInvestido);
            invoiceValueEl.textContent = formatCurrency(faturaAtual);
            debtsValueEl.textContent = formatCurrency(totalDebtBalance);
            updateOverviewCard();
        };

        const generateTransactionListHTML = (data, cardType) => {
            if(data.length===0) return '<p class="text-gray-500 text-center py-4">Nenhuma transação encontrada.</p>';
            let headers = [{key:'date',label:'Data'},{key:'description',label:'Descrição'},{key:'category',label:'Categoria'},{key:'amount',label:'Valor'}];
            if (cardType === 'balance') {
                headers.push({key:'actions', label: 'Ações'});
            }
            const headerHTML = headers.map(h => `<th class="p-3 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider ${h.key !== 'actions' ? `sortable-header ${currentSort.key===h.key?currentSort.direction:''}` : ''}" data-sort-key="${h.key}">${h.label} ${h.key !== 'actions' ? '<span class="sort-icon">▲</span>' : ''}</th>`).join('');
            
            const rowsHTML = data.map(t => {
                let actionCell = '';
                if (cardType === 'balance') {
                    actionCell = `<td class="p-3 text-center">
                                        <button data-action="delete-transaction" data-id="${t.id}" class="p-1 text-gray-400 hover:text-red-600 rounded-full" title="Excluir Transação">
                                            <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </td>`;
                }
                return `<tr class="border-b border-gray-200 hover:bg-gray-50" data-id="${t.id}" title="Clique para editar">
                            <td class="p-3 whitespace-nowrap">${formatDate(t.date)}</td>
                            <td class="p-3">${t.description||'-'}</td>
                            <td class="p-3">${t.category}${t.subcategory?' ('+t.subcategory+')':''}</td>
                            <td class="p-3 text-right font-medium">${(t.type==='saida'||t.type==='investimento')?'-':''}${formatCurrency(t.amount)}</td>
                            ${actionCell}
                        </tr>`;
            }).join('');
            
            return `<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-100"><tr>${headerHTML}</tr></thead><tbody id="transaction-list-body">${rowsHTML}</tbody></table></div>`;
        };
        
        const handlePendingAction = async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const { action, id } = button.dataset;
            const transactionId = parseInt(id);
            const transactionIndex = transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return;
            const transaction = transactions[transactionIndex];
            if (action === 'approve') {
                if(transaction.isVariable && !transaction.debtId){const inputEl=document.querySelector(`input[data-amount-input-id="${transactionId}"]`);if(inputEl){const newAmount=parseFloat(inputEl.value);if(!isNaN(newAmount)&&newAmount>0){transaction.amount=newAmount}else{inputEl.focus();inputEl.classList.add('invalid-field');setTimeout(()=>inputEl.classList.remove('invalid-field'),2000);return}}}
                transaction.status = 'completed';
                
                if (transaction.debtId && transaction.installmentNumber) {
                    const debt = debts.find(d => d.id === transaction.debtId);
                    if(debt){const installment=debt.installments.find(p=>p.number===transaction.installmentNumber);if(installment)installment.status='paid'}
                }
            } else if (action === 'delete') {
                if (transaction.templateId) {
                    const choice = await showGenericModal({title:'Excluir Transação Pendente',message:'Esta é uma transação recorrente. O que você deseja fazer?',buttons:[{text:'Cancelar',value:'cancel',classes:'bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-semibold'},{text:'Excluir Somente Esta',value:'one',classes:'bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold'},{text:'Parar Recorrência',value:'all',classes:'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-semibold'}]});
                    if (choice === 'one') {
                         transactions.splice(transactionIndex, 1);
                    } else if (choice === 'all') {
                        const templateIdToDelete = transaction.templateId;
                        transactions = transactions.filter(t => t.templateId !== templateIdToDelete || t.status === 'completed');
                        fixedTransactionTemplates = fixedTransactionTemplates.filter(t => t.id !== templateIdToDelete);
                    }
                } else if (transaction.debtId) {
                    await showGenericModal({type:'alert',title:'Ação Inválida',message:'Parcelas de dívidas não podem ser excluídas por aqui. Para cancelar, gerencie a dívida original.'});
                    return;
                } else {
                    transactions.splice(transactionIndex, 1);
                }
            }
            await saveData();
            updateDashboard();
            if(!pendingTransactionsModal.classList.contains('hidden')){
                renderPendingModalList();
            }
        };

        const applyFiltersAndRender = (baseData, cardType) => {
            let filteredData = [...baseData];
            const startDate = document.getElementById('modal-start-date-filter')?.value;
            const endDate = document.getElementById('modal-end-date-filter')?.value;
            if (startDate) filteredData = filteredData.filter(t => new Date(t.date) >= new Date(startDate));
            if (endDate) filteredData = filteredData.filter(t => new Date(t.date) <= new Date(endDate));
            if (activeFilters.type !== 'all') filteredData = filteredData.filter(t => t.type === activeFilters.type);
            if (activeFilters.category !== 'all') filteredData = filteredData.filter(t => t.category === activeFilters.category);
            if (activeFilters.subcategory !== 'all') filteredData = filteredData.filter(t => t.subcategory === activeFilters.subcategory);
            
            // ALTERAÇÃO: Lógica de cálculo e exibição de totais
            const totalAmount = filteredData.reduce((sum, t) => {
                if (cardType === 'overview-expenses') return sum + t.amount;
                if (t.type === 'entrada') return sum + t.amount;
                if (t.type === 'saida' || t.type === 'investimento') return sum - t.amount;
                return sum;
            }, 0);
            
            const totalFilteredEl = document.getElementById('modal-total-filtered');
            if (totalFilteredEl) {
                totalFilteredEl.textContent = formatCurrency(totalAmount);
                totalFilteredEl.className = `text-lg font-bold ${totalAmount >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }

            filteredData.sort((a,b)=>{let valA=a[currentSort.key];let valB=b[currentSort.key];if(typeof valA==='string'){valA=valA.toLowerCase();valB=valB.toLowerCase()}if(valA<valB)return currentSort.direction==='asc'?-1:1;if(valA>valB)return currentSort.direction==='asc'?1:-1;return 0});
            currentFilteredModalData = filteredData;
            transactionsModalList.innerHTML = generateTransactionListHTML(filteredData, cardType);
            transactionsModalList.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sortKey;
                    if(currentSort.key===sortKey){currentSort.direction=currentSort.direction==='asc'?'desc':'asc'}else{currentSort.key=sortKey;currentSort.direction='desc'}
                    applyFiltersAndRender(baseData, cardType);
                });
            });
        };

        const openTransactionsModal = (config) => {
            transactionsModalTitle.textContent = config.title;
            modalTransactionData = [...config.transactions];
            transactionsModalFilters.innerHTML = '';
            transactionsModalList.innerHTML = '';
            activeFilters = { type: 'all', category: 'all', subcategory: 'all', startDate: '', endDate: '' };
            currentSort = { key: 'date', direction: 'desc' };
            exportBtn.classList.toggle('hidden', config.cardType !== 'balance');
            let filtersHTML = '<div class="space-y-4 p-3 bg-gray-50 rounded-md border">';
            let mainFiltersHTML = '<div class="flex flex-wrap items-end gap-4">';
            if(config.filters.includes('period')){mainFiltersHTML+=`<div class="flex-shrink-0"><label for="modal-start-date-filter" class="text-sm font-medium text-gray-700">De:</label><input type="date" id="modal-start-date-filter" class="w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><div class="flex-shrink-0"><label for="modal-end-date-filter" class="text-sm font-medium text-gray-700">Até:</label><input type="date" id="modal-end-date-filter" class="w-full border border-gray-300 rounded-md shadow-sm py-1.5 px-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>`}
            if(config.filters.includes('type')){mainFiltersHTML+=`<div class="flex-shrink-0"><span class="text-sm font-medium text-gray-700 block mb-1">Tipo:</span><div id="modal-type-filter-buttons" class="flex rounded-md shadow-sm"><button data-type="all" class="filter-type-btn active">Todos</button><button data-type="entrada" class="filter-type-btn">Entrada</button><button data-type="saida" class="filter-type-btn">Saída</button><button data-type="investimento" class="filter-type-btn">Invest.</button></div></div>`}
            if(config.filters.includes('category')){const allCategories=[...new Set(modalTransactionData.map(t=>t.category))].sort();let options='<option value="all">Todas as Categorias</option>';allCategories.forEach(cat=>{options+=`<option value="${cat}">${cat}</option>`});mainFiltersHTML+=`<div class="flex-grow"><label for="modal-category-filter" class="text-sm font-medium text-gray-700">Categoria:</label><select id="modal-category-filter" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">${options}</select></div>`}
            if(config.filters.includes('subcategory')){const allSubcategories=[...new Set(modalTransactionData.map(t=>t.subcategory).filter(Boolean))].sort();let options='<option value="all">Todas as Subcategorias</option>';allSubcategories.forEach(sub=>{options+=`<option value="${sub}">${sub}</option>`});mainFiltersHTML+=`<div class="flex-grow"><label for="modal-subcategory-filter" class="text-sm font-medium text-gray-700">Subcategoria:</label><select id="modal-subcategory-filter" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">${options}</select></div>`}
            mainFiltersHTML+='</div>';filtersHTML+=mainFiltersHTML;
            filtersHTML+='</div>';transactionsModalFilters.innerHTML=filtersHTML;

            // ALTERAÇÃO: Lógica para mostrar footer e calcular total do período
            const modalFooter = document.getElementById('transactions-modal-footer');
            const totalPeriodEl = document.getElementById('modal-total-period');
            
            const totalPeriodAmount = modalTransactionData.reduce((sum, t) => {
                // Para o extrato de saídas, somamos os valores, em vez de subtrair
                if (config.cardType === 'overview-expenses') return sum + t.amount;
                // Para os demais, calculamos o saldo
                if (t.type === 'entrada') return sum + t.amount;
                if (t.type === 'saida' || t.type === 'investimento') return sum - t.amount;
                return sum;
            }, 0);

            totalPeriodEl.textContent = formatCurrency(totalPeriodAmount);
            totalPeriodEl.className = `text-lg font-bold ${totalPeriodAmount >= 0 ? 'text-gray-800' : 'text-red-700'}`;
            modalFooter.classList.remove('hidden');

            const updateOnChange=()=>{applyFiltersAndRender(modalTransactionData, config.cardType)};
            document.querySelectorAll('.filter-type-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.filter-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');activeFilters.type=btn.dataset.type;updateOnChange()})});
            ['modal-start-date-filter','modal-end-date-filter','modal-category-filter','modal-subcategory-filter'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('change', (e) => { const filterType = e.target.id.split('-')[1]; activeFilters[filterType] = e.target.value; updateOnChange(); }); });
            applyFiltersAndRender(modalTransactionData, config.cardType);
            transactionsModal.classList.remove('hidden');
        };

        const toggleValuesVisibility = () => {
            areValuesVisible = !areValuesVisible;
            valueElements.forEach(el => { el.classList.toggle('value-hidden', !areValuesVisible); el.classList.toggle('value-visible', areValuesVisible); });
            toggleVisibilityBtns.forEach(btn => { btn.innerHTML = areValuesVisible ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>` : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .525-1.666 1.489-3.14 2.675-4.325m11.313 4.325a10.049 10.049 0 01-4.425 4.425m-7.233-7.233C6.63 7.423 9.17 6 12 6c1.556 0 3.041.455 4.385 1.25M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`; });
        };

        const openModal = () => { transactionModal.classList.remove('hidden'); if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0]; setDefaultTransactionType(); };
        const closeModal = () => { transactionModal.classList.add('hidden'); transactionForm.reset(); resetTypeButtons(); isVariableContainer.classList.add('hidden'); recurrencePeriodContainer.classList.add('hidden'); recurrenceCountContainer.classList.add('hidden'); selectedTransactionType=null; document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field')); formErrorMessage.classList.add('hidden'); editingTransactionId=null; document.getElementById('modal-headline').textContent='Nova Transação'; transactionForm.querySelector('button[type="submit"]').textContent='Adicionar Transação'; isFixedCheckbox.disabled=false; document.getElementById('is-variable').disabled=false; };

        const openModalForEdit = (transactionId) => {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction || transaction.status !== 'completed') { if(transaction?.status==='pending') showGenericModal({type:'alert',title:'Aviso',message:'Não é possível editar uma transação pendente. Aprove-a primeiro.'}); return; };
            if (transaction.debtId) { showGenericModal({type:'alert',title:'Aviso',message:'Pagamentos de dívidas não podem ser editados diretamente.'}); return; }
            editingTransactionId = transactionId;
            document.getElementById('modal-headline').textContent = 'Editar Transação';
            transactionForm.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
            resetTypeButtons();
            const typeBtn = document.querySelector(`.transaction-type-btn[data-type="${transaction.type}"]`);
            if (typeBtn) { typeBtn.classList.add('active'); selectedTransactionType = transaction.type; updateFormForType(transaction.type); }
            amountInput.value = transaction.amount;
            dateInput.value = transaction.date;
            document.getElementById('description').value = transaction.description || '';
            setTimeout(() => { categorySelect.value=transaction.category; populateSubcategories(); subcategorySelect.value=transaction.subcategory||''; if(transaction.type==='saida'){paymentMethodSelect.value=transaction['payment-method']||''} }, 10);
            isFixedCheckbox.checked = transaction.isFixed;
            isFixedCheckbox.disabled = true;
            isVariableContainer.classList.toggle('hidden', !transaction.isFixed);
            recurrencePeriodContainer.classList.toggle('hidden', !transaction.isFixed);
            recurrenceCountContainer.classList.toggle('hidden', !transaction.isFixed);
            if (transaction.isFixed) {
                document.getElementById('recurrence-period').value = transaction.recurrencePeriod || 'monthly';
                document.getElementById('recurrence-count').value = transaction.recurrenceCount || '';
            }
            document.getElementById('recurrence-period').disabled = true;
            document.getElementById('recurrence-count').disabled = true;
            document.getElementById('is-variable').checked = transaction.isVariable;
            document.getElementById('is-variable').disabled = true;
            closeTransactionsModal();
            transactionModal.classList.remove('hidden');
        };

        const resetTypeButtons = () => transactionTypeBtns.forEach(btn => btn.classList.remove('active'));
        const updateFormForType = (type) => { populateCategories(type); paymentMethodContainer.classList.toggle('hidden', type !== 'saida'); };
        const setDefaultTransactionType = () => { resetTypeButtons(); const defaultType='saida'; const defaultBtn=document.querySelector(`.transaction-type-btn[data-type="${defaultType}"]`); if(defaultBtn){defaultBtn.classList.add('active');selectedTransactionType=defaultType;updateFormForType(defaultType)} };

        const populateCategories = (type) => {
            if(!categorySelect) return;
            const currentCategory=categorySelect.value;
            categorySelect.innerHTML='<option value="">Selecione</option>';
            if(type&&categoryData[type]){Object.keys(categoryData[type]).sort((a,b)=>a.localeCompare(b)).forEach(cat=>{const option=document.createElement('option');option.value=cat;option.textContent=cat;categorySelect.appendChild(option)})}
            if(categoryData[type]?.[currentCategory]){categorySelect.value=currentCategory}
            populateSubcategories();
        };

        const populateSubcategories = () => {
            if(!subcategorySelect) return;
            const currentSubcategory=subcategorySelect.value;
            const selectedCategory=categorySelect.value;
            subcategorySelect.innerHTML='<option value="">Selecione</option>';
            if(selectedCategory&&selectedTransactionType&&categoryData[selectedTransactionType]?.[selectedCategory]){categoryData[selectedTransactionType][selectedCategory].sort((a,b)=>a.localeCompare(b)).forEach(sub=>{const option=document.createElement('option');option.value=sub;option.textContent=sub;subcategorySelect.appendChild(option)})}
            if(categoryData[selectedTransactionType]?.[selectedCategory]?.includes(currentSubcategory)){subcategorySelect.value=currentSubcategory}
        };

        const closeTransactionsModal = () => transactionsModal.classList.add('hidden');

        const validateForm = () => {
            const errors=[]; let isValid=true;
            document.querySelectorAll('.invalid-field').forEach(el=>el.classList.remove('invalid-field'));
            if(!selectedTransactionType){errors.push('Selecione um tipo de transação.');isValid=false}
            if(!amountInput.value||parseFloat(amountInput.value)<=0){errors.push('O valor deve ser maior que zero.');amountInput.classList.add('invalid-field');isValid=false}
            if(!dateInput.value){errors.push('Selecione uma data.');dateInput.classList.add('invalid-field');isValid=false}
            if(!categorySelect.value){errors.push('Selecione uma categoria.');categorySelect.classList.add('invalid-field');isValid=false}
            if(selectedTransactionType==='saida'&&!paymentMethodSelect.value){errors.push('Selecione uma forma de pagamento.');paymentMethodSelect.classList.add('invalid-field');isValid=false}
            if(!isValid){formErrorMessage.innerHTML=errors.join('<br>');formErrorMessage.classList.remove('hidden')}else{formErrorMessage.classList.add('hidden')}
            return isValid;
        };

        const showGenericModal = (config) => {
            return new Promise((resolve) => {
                genericModalTitle.textContent = config.title;
                genericModalMessage.textContent = config.message || '';
                genericModalMessage.classList.toggle('hidden', !config.message);
                genericModalInputContainer.classList.toggle('hidden', config.type !== 'prompt');
                genericModalInput.value = config.defaultValue || '';
                genericModalButtons.innerHTML = '';
                const createButton = (text, classes, value) => {
                    const button = document.createElement('button');
                    button.textContent = text;
                    button.className = classes;
                    button.onclick = () => { genericModal.classList.add('hidden'); resolve(value === 'input' ? genericModalInput.value : value); };
                    genericModalButtons.appendChild(button);
                };
                if(config.buttons){config.buttons.forEach(btnConfig=>{createButton(btnConfig.text,btnConfig.classes,btnConfig.value)})}
                else{switch(config.type){case'alert':createButton('OK','bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold',true);break;case'confirm':createButton('Cancelar','bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-semibold',false);createButton('Confirmar','bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-semibold',true);break;case'prompt':createButton('Cancelar','bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 font-semibold',null);createButton('Salvar','bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold','input');break;}}
                genericModal.classList.remove('hidden');
                if (config.type === 'prompt') genericModalInput.focus();
            });
        };

        const openSettingsModal = () => {
            invoiceClosingDayInput.value = settings.invoiceClosingDay;
            savingsGoalInput.value = settings.savingsGoal > 0 ? settings.savingsGoal : '';
            renderCategoryManagement();
            settingsModal.classList.remove('hidden');
        };
        const closeSettingsModal = () => settingsModal.classList.add('hidden');
        
        const renderCategoryManagement = () => {
            categoryManagementContainer.innerHTML = '';
            const typeTitles = { 'entrada':'Receitas', 'saida':'Despesas', 'investimento':'Investimentos' };
            Object.keys(categoryData).forEach(type => {
                const typeDetails = document.createElement('details');
                typeDetails.className = 'type-item bg-white rounded-lg border border-gray-200';
                const typeSummary = document.createElement('summary');
                typeSummary.className = 'p-3 cursor-pointer font-semibold text-gray-700 flex justify-between items-center';
                typeSummary.innerHTML = `<span>${typeTitles[type]}</span><svg class="w-5 h-5 transition-transform transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                typeDetails.appendChild(typeSummary);
                const typeContent = document.createElement('div');
                typeContent.className = 'p-3 border-t space-y-2';
                const categories = categoryData[type];
                Object.keys(categories).sort((a,b) => a.localeCompare(b)).forEach(category => {
                    const categoryItem = document.createElement('details');
                    categoryItem.className = 'category-item bg-gray-50 rounded-md border';
                    const summary = document.createElement('summary');
                    summary.className = 'flex items-center justify-between p-2 cursor-pointer';
                    const nameAndBudget = document.createElement('div');
                    nameAndBudget.className = 'flex items-center space-x-2';
                    nameAndBudget.innerHTML = `<span class="font-medium text-gray-800">${category}</span>`;
                    if (type === 'saida') {
                        nameAndBudget.innerHTML += `<input type="number" data-budget-category="${category}" step="0.01" placeholder="Orçamento" value="${settings.budgets[category] || ''}" class="w-28 border border-gray-200 rounded-md py-1 px-2 text-sm">`;
                    }
                    const buttons = document.createElement('div');
                    buttons.className = 'flex items-center space-x-1';
                    buttons.innerHTML = `<button title="Editar Categoria" data-action="edit-category" data-type="${type}" data-category="${category}" class="p-1 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button><button title="Excluir Categoria" data-action="delete-category" data-type="${type}" data-category="${category}" class="p-1 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
                    summary.appendChild(nameAndBudget);
                    summary.appendChild(buttons);
                    categoryItem.appendChild(summary);
                    const subCategoryContainer = document.createElement('div');
                    subCategoryContainer.className = 'pl-6 pr-2 pb-2';
                    categories[category].sort((a,b) => a.localeCompare(b)).forEach(sub => { subCategoryContainer.innerHTML += `<div class="flex items-center justify-between py-1 border-t"><span class="text-sm text-gray-700">${sub}</span><div class="flex items-center space-x-1"><button title="Editar Subcategoria" data-action="edit-subcategory" data-type="${type}" data-category="${category}" data-subcategory="${sub}" class="p-1 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button><button title="Excluir Subcategoria" data-action="delete-subcategory" data-type="${type}" data-category="${category}" data-subcategory="${sub}" class="p-1 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div>`; });
                    subCategoryContainer.innerHTML += `<div class="mt-2"><button data-action="add-subcategory" data-type="${type}" data-category="${category}" class="text-sm text-blue-600 hover:underline">+ Adicionar Subcategoria</button></div>`;
                    categoryItem.appendChild(subCategoryContainer);
                    typeContent.appendChild(categoryItem);
                });
                typeContent.innerHTML += `<div class="mt-4"><button data-action="add-category" data-type="${type}" class="w-full text-center text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 rounded-md">+ Adicionar Categoria</button></div>`;
                typeDetails.appendChild(typeContent);
                categoryManagementContainer.appendChild(typeDetails);
            });
        };

        const handleCategoryManagementAction = async (e) => {
            const target = e.target;
            if (target.matches('input[data-budget-category]')) { const category = target.dataset.budgetCategory; const value = parseFloat(target.value); if (value > 0) settings.budgets[category] = value; else delete settings.budgets[category]; return; }
            const button = target.closest('button');
            if (!button) return;
            const { action, type, category, subcategory } = button.dataset;
            if (!action) return;
            e.preventDefault();
            const typeTitles = { entrada: 'Receitas', saida: 'Despesas', investimento: 'Investimentos' };
            switch(action) {
                case 'add-category': { const newName = await showGenericModal({ type: 'prompt', title: `Nova Categoria em ${typeTitles[type]}`, message: 'Digite o nome da nova categoria:'}); if (newName && !categoryData[type][newName]) { categoryData[type][newName] = []; if (type === 'saida') settings.budgets[newName] = 0; renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } else if (newName) { await showGenericModal({ type: 'alert', title: 'Erro', message: 'Essa categoria já existe.'}); } break; }
                case 'delete-category': { const confirmed = await showGenericModal({ type: 'confirm', title: 'Excluir Categoria', message: `Tem certeza que deseja excluir a categoria "${category}"?`}); if (confirmed) { delete categoryData[type][category]; if (type === 'saida') delete settings.budgets[category]; renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } break; }
                case 'edit-category': { const newName = await showGenericModal({ type: 'prompt', title: 'Editar Categoria', message: `Novo nome para "${category}":`, defaultValue: category }); if (newName && newName !== category && !categoryData[type][newName]) { Object.defineProperty(categoryData[type], newName, Object.getOwnPropertyDescriptor(categoryData[type], category)); delete categoryData[type][category]; if (type === 'saida' && settings.budgets[category] !== undefined) { settings.budgets[newName] = settings.budgets[category]; delete settings.budgets[category]; } renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } else if (newName && newName !== category) { await showGenericModal({ type: 'alert', title: 'Erro', message: 'Essa categoria já existe.'}); } break; }
                case 'add-subcategory': { const newSub = await showGenericModal({ type: 'prompt', title: 'Nova Subcategoria', message: `Nome da nova subcategoria para "${category}":`}); if (newSub && !categoryData[type][category].includes(newSub)) { categoryData[type][category].push(newSub); renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } else if (newSub) { await showGenericModal({ type: 'alert', title: 'Erro', message: 'Essa subcategoria já existe.'}); } break; }
                case 'delete-subcategory': { const confirmed = await showGenericModal({ type: 'confirm', title: 'Excluir Subcategoria', message: `Tem certeza que deseja excluir a subcategoria "${subcategory}"?`}); if (confirmed) { const index = categoryData[type][category].indexOf(subcategory); if (index > -1) { categoryData[type][category].splice(index, 1); renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } } break; }
                case 'edit-subcategory': { const newName = await showGenericModal({ type: 'prompt', title: 'Editar Subcategoria', message: `Novo nome para "${subcategory}":`, defaultValue: subcategory}); const index = categoryData[type][category].indexOf(subcategory); if (newName && newName !== subcategory && !categoryData[type][category].includes(newName) && index > -1) { categoryData[type][category][index] = newName; renderCategoryManagement(); populateCategories(selectedTransactionType); saveData(); } else if (newName && newName !== subcategory) { await showGenericModal({ type: 'alert', title: 'Erro', message: 'Essa subcategoria já existe.'}); } break; }
            }
        };

        const updateOverviewCard = () => {
            const monthName = currentPendingDate.toLocaleString('pt-BR', { month: 'long' });
            const year = currentPendingDate.getFullYear();
            pendingMonthDisplay.textContent = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;

            const currentMonth = currentPendingDate.getMonth();
            const currentYear = currentPendingDate.getFullYear();
            const transactionsThisMonth = transactions.filter(t => { const tDate=new Date(t.date+'T00:00:00'); return tDate.getMonth()===currentMonth&&tDate.getFullYear()===currentYear; });
            const completedThisMonth = transactionsThisMonth.filter(t => t.status === 'completed');
            const pendingThisMonth = transactionsThisMonth.filter(t => t.status === 'pending');
            
            if (pendingThisMonth.length > 0) {
                pendingCountBadge.textContent = pendingThisMonth.length;
                viewPendingBtn.classList.remove('hidden');
            } else {
                viewPendingBtn.classList.add('hidden');
            }

            const income = completedThisMonth.filter(t => t.type === 'entrada').reduce((sum, t) => sum + t.amount, 0);
            const expenses = completedThisMonth.filter(t => t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expenses;
            overviewIncomeEl.textContent = formatCurrency(income);
            overviewExpensesEl.textContent = formatCurrency(expenses);
            overviewBalanceEl.textContent = formatCurrency(balance);
            const pendingIncome = pendingThisMonth.filter(t => t.type === 'entrada').reduce((sum, t) => sum + t.amount, 0);
            const pendingExpenses = pendingThisMonth.filter(t => t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
            overviewIncomePendingEl.textContent = pendingIncome > 0 ? `(+ ${formatCurrency(pendingIncome)} pendente)` : '';
            overviewExpensesPendingEl.textContent = pendingExpenses > 0 ? `(+ ${formatCurrency(pendingExpenses)} pendente)` : '';
            const expenseByCategory = completedThisMonth.filter(t => t.type === 'saida').reduce((acc, t) => { acc[t.category]=(acc[t.category]||0)+t.amount; return acc; }, {});
            const chartLabels = Object.keys(expenseByCategory);
            const chartData = Object.values(expenseByCategory);
            if (categoryChartInstance) { categoryChartInstance.destroy(); }
            if (chartLabels.length > 0) {
                categoryChartInstance = new Chart(categoryChartCanvas, { type: 'doughnut', data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899'], borderWidth: 0, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            } else { categoryChartCanvas.getContext('2d').clearRect(0, 0, categoryChartCanvas.width, categoryChartCanvas.height); }
            budgetBarsContainer.innerHTML = '';
            const budgetedCategories = Object.keys(settings.budgets);
            budgetedCategories.forEach(category => {
                const budgetAmount = settings.budgets[category] || 0;
                if (budgetAmount <= 0) return;
                const spentCompleted = completedThisMonth.filter(t => t.category === category && t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                const spentPending = pendingThisMonth.filter(t => t.category === category && t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                const totalSpent = spentCompleted + spentPending;
                const completedPercent = (spentCompleted / budgetAmount) * 100;
                const pendingPercent = (spentPending / budgetAmount) * 100;
                budgetBarsContainer.innerHTML += `<div class="budget-bar-container rounded-md p-2 cursor-pointer" data-category="${category}"><div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold text-gray-700">${category}</span><span class="text-gray-500"><span class="value-visible font-medium text-gray-800">${formatCurrency(totalSpent)}</span> / ${formatCurrency(budgetAmount)}</span></div><div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden flex"><div class="bg-green-500 h-4" style="width:${Math.min(completedPercent,100)}%"></div><div class="bg-gray-400 h-4" style="width:${Math.min(pendingPercent,100-completedPercent)}%"></div></div></div>`;
            });
            const allExpenseCategoriesThisMonth = [...new Set(transactionsThisMonth.filter(t => t.type === 'saida').map(t => t.category))];
            const unbudgetedCategories = allExpenseCategoriesThisMonth.filter(cat => !budgetedCategories.includes(cat) || !settings.budgets[cat]);
            if (unbudgetedCategories.length > 0) {
                let unbudgetedHTML = '<h4 class="text-sm font-semibold text-gray-600 mt-4 border-t pt-3">Gastos Não Orçados</h4>';
                unbudgetedCategories.forEach(category => {
                    const totalSpent = transactionsThisMonth.filter(t => t.category === category && t.type === 'saida').reduce((sum, t) => sum + t.amount, 0);
                    unbudgetedHTML += `<div class="flex items-center justify-between p-2 bg-yellow-50 border border-yellow-200 rounded-md"><div class="flex items-center"><svg class="w-5 h-5 text-yellow-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span class="font-semibold text-gray-700">${category}</span></div><div class="flex items-center"><span class="text-gray-600 mr-3 font-medium value-visible">${formatCurrency(totalSpent)}</span><button data-action="regularize" data-category="${category}" class="text-sm text-blue-600 hover:underline font-semibold">Regularizar</button></div></div>`;
                });
                budgetBarsContainer.innerHTML += unbudgetedHTML;
            }
            if(settings.savingsGoal > 0){ const savedAmount=balance; const savedPercent=Math.max(0,(savedAmount/settings.savingsGoal)*100); budgetBarsContainer.innerHTML+=`<div class="mt-6 border-t pt-4"><div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold text-gray-700">Meta de Economia</span><span class="text-gray-500"><span class="value-visible font-medium text-gray-800">${formatCurrency(savedAmount)}</span> / ${formatCurrency(settings.savingsGoal)}</span></div><div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden"><div class="bg-blue-500 h-4" style="width:${Math.min(savedPercent,100)}%"></div></div></div>`; }
        };

        const openForecastModal = () => { calculateAndRenderForecast(); forecastModal.classList.remove('hidden'); };
        const closeForecastModal = () => forecastModal.classList.add('hidden');
        
        const calculateAndRenderForecast = () => {
            const completed = transactions.filter(t => t.status === 'completed' && !t.templateId);
            const historicalMonths = new Set();
            completed.forEach(t => { const [year, month] = t.date.split('-'); historicalMonths.add(`${year}-${month}`); });
            const monthCount = historicalMonths.size > 0 ? historicalMonths.size : 1;
            const avgVarIncome = completed.filter(t => t.type === 'entrada').reduce((s, t) => s + t.amount, 0) / monthCount;
            const avgVarExpense = completed.filter(t => t.type === 'saida').reduce((s, t) => s + t.amount, 0) / monthCount;
            const avgVarInvestment = completed.filter(t => t.type === 'investimento').reduce((s, t) => s + t.amount, 0) / monthCount;
            const fixedIncome = fixedTransactionTemplates.filter(t => t.type === 'entrada').reduce((s, t) => s + t.amount, 0);
            const fixedExpense = fixedTransactionTemplates.filter(t => t.type === 'saida').reduce((s, t) => s + t.amount, 0);
            const fixedInvestment = fixedTransactionTemplates.filter(t => t.type === 'investimento').reduce((s, t) => s + t.amount, 0);
            const totalAvgIncome = avgVarIncome + fixedIncome;
            const totalAvgExpense = avgVarExpense + fixedExpense;
            const totalAvgInvestment = avgVarInvestment + fixedInvestment;
            const totalAvgBalance = totalAvgIncome - totalAvgExpense - totalAvgInvestment;
            document.getElementById('forecast-avg-income').textContent = formatCurrency(totalAvgIncome);
            document.getElementById('forecast-avg-expense').textContent = formatCurrency(totalAvgExpense);
            document.getElementById('forecast-avg-investment').textContent = formatCurrency(totalAvgInvestment);
            document.getElementById('forecast-avg-balance').textContent = formatCurrency(totalAvgBalance);
            const labels = []; const incomeData = []; const expenseData = []; const balanceData = [];
            const completedTransactions = transactions.filter(t => t.status === 'completed');
            const currentBalance = completedTransactions.filter(t => t.type === 'entrada').reduce((acc, t) => acc + t.amount, 0) - completedTransactions.filter(t => t.type === 'saida' || t.type === 'investimento').reduce((acc, t) => acc + t.amount, 0);
            
            let cumulativeBalance = currentBalance;
            let cumulativeIncome = 0;
            let cumulativeExpenses = 0;

            forecastDataForExport = [];
            for (let i = 1; i <= 12; i++) {
                const futureDate = new Date(); futureDate.setMonth(futureDate.getMonth() + i);
                labels.push(futureDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
                
                cumulativeBalance += totalAvgBalance;
                cumulativeIncome += totalAvgIncome;
                cumulativeExpenses += (totalAvgExpense + totalAvgInvestment);
                
                incomeData.push(cumulativeIncome); 
                expenseData.push(cumulativeExpenses); 
                balanceData.push(cumulativeBalance);
                
                forecastDataForExport.push({ 'Mês': futureDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }), 'Receita Projetada': cumulativeIncome, 'Despesa Projetada': cumulativeExpenses, 'Saldo Projetado': cumulativeBalance });
            }
            if(forecastChartInstance) forecastChartInstance.destroy();
            forecastChartInstance = new Chart(forecastChartCanvas, { type: 'line', data: { labels: labels, datasets: [ { label: 'Saldo', data: balanceData, borderColor: '#3b82f6', backgroundColor: '#3b82f620', fill: true, tension: 0.1 }, { label: 'Receitas', data: incomeData, borderColor: '#22c55e', tension: 0.1 }, { label: 'Despesas', data: expenseData, borderColor: '#ef4444', tension: 0.1 } ] }, options: { responsive: true, maintainAspectRatio: false } });
        };
        const exportForecastDataToXLSX = () => {
            if(forecastDataForExport.length===0){showGenericModal({type:'alert',title:'Aviso',message:'Não há dados para exportar.'});return}
            const worksheet=XLSX.utils.json_to_sheet(forecastDataForExport);const workbook=XLSX.utils.book_new();XLSX.utils.book_append_sheet(workbook,worksheet,"Previsao_Futura");XLSX.writeFile(workbook,"previsao_financeira.xlsx");
        };
        const exportFilteredDataToXLSX = () => {
            if(currentFilteredModalData.length===0){showGenericModal({type:'alert',title:'Aviso',message:'Não há dados para exportar.'});return}
            const dataToExport=currentFilteredModalData.map(t=>({'Data':formatDate(t.date),'Descrição':t.description,'Tipo':t.type,'Categoria':t.category,'Subcategoria':t.subcategory||'','Valor':t.amount}));
            const worksheet=XLSX.utils.json_to_sheet(dataToExport);const workbook=XLSX.utils.book_new();XLSX.utils.book_append_sheet(workbook,worksheet,"Transacoes");XLSX.writeFile(workbook,"extrato_financeiro.xlsx");
        };
        const downloadTemplateXLSX = () => {
            const transactionsData = [ { Data: '2025-10-05', Descrição: 'Salário', Tipo: 'entrada', Categoria: 'Salário', Subcategoria: 'Salário Mensal', Valor: 5000.00, 'Forma Pagamento': '' }, { Data: '2025-10-07', Descrição: 'Aluguel', Tipo: 'saida', Categoria: 'Moradia', Subcategoria: 'Aluguel', Valor: 1500.00, 'Forma Pagamento': 'Transferência Bancária' } ];
            const categoriesData = [ { Tipo: 'saida', Categoria: 'Alimentação', Subcategoria: 'Supermercado' }, { Tipo: 'saida', Categoria: 'Alimentação', Subcategoria: 'Restaurante' }, { Tipo: 'entrada', Categoria: 'Salário', Subcategoria: 'Salário Mensal' } ];
            const wsTransactions = XLSX.utils.json_to_sheet(transactionsData);
            const wsCategories = XLSX.utils.json_to_sheet(categoriesData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsTransactions, 'Transacoes');
            XLSX.utils.book_append_sheet(wb, wsCategories, 'Categorias');
            XLSX.writeFile(wb, 'modelo_importacao.xlsx');
        };
        const exportAllDataToXLSX = () => {
            const transactionsToExport = transactions.map(t => ({...t}));
            const flatCategories = [];
            Object.keys(categoryData).forEach(type => { Object.keys(categoryData[type]).forEach(category => { if (categoryData[type][category].length > 0) { categoryData[type][category].forEach(subcategory => { flatCategories.push({ Tipo: type, Categoria: category, Subcategoria: subcategory }); }); } else { flatCategories.push({ Tipo: type, Categoria: category, Subcategoria: '' }); } }); });
            const wsTransactions = XLSX.utils.json_to_sheet(transactionsToExport);
            const wsCategories = XLSX.utils.json_to_sheet(flatCategories);
            const wsSettings = XLSX.utils.json_to_sheet([settings]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsTransactions, 'Transacoes');
            XLSX.utils.book_append_sheet(wb, wsCategories, 'Categorias');
            XLSX.utils.book_append_sheet(wb, wsSettings, 'Configuracoes');
            XLSX.writeFile(wb, 'backup_financeiro_completo.xlsx');
        };
        const importDataFromXLSX = (file) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const wsTransactions = workbook.Sheets['Transacoes'];
                    const wsCategories = workbook.Sheets['Categorias'];
                    const wsSettings = workbook.Sheets['Configuracoes'];
                    if(!wsTransactions || !wsCategories) { throw new Error('Arquivo deve conter "Transacoes" e "Categorias".'); }
                    const confirmed = await showGenericModal({ type: 'confirm', title: 'Importar Dados', message: 'Isso substituirá TODOS os seus dados atuais. Continuar?' });
                    if (!confirmed) return;
                    const newTransactions = XLSX.utils.sheet_to_json(wsTransactions);
                    transactions = newTransactions.map(t => ({...t, date: new Date((t.Data - (25567 + 2)) * 86400 * 1000).toISOString().split('T')[0]}));
                    fixedTransactionTemplates = transactions.filter(t => t.templateId && !transactions.some(t2 => t2.id === t.templateId));
                    const newCategoriesData = XLSX.utils.sheet_to_json(wsCategories);
                    const importedCategoryData = {'entrada': {}, 'saida': {}, 'investimento': {}};
                    newCategoriesData.forEach(row => { if (!importedCategoryData[row.Tipo]) return; if (!importedCategoryData[row.Tipo][row.Categoria]) { importedCategoryData[row.Tipo][row.Categoria] = []; } if (row.Subcategoria) { importedCategoryData[row.Tipo][row.Categoria].push(row.Subcategoria); } });
                    categoryData = importedCategoryData;
                    if(wsSettings) { const newSettings = XLSX.utils.sheet_to_json(wsSettings)[0]; if(newSettings) settings = newSettings; }
                    updateDashboard();
                    saveData();
                    await showGenericModal({type: 'alert', title: 'Sucesso', message: 'Dados importados com sucesso!'});
                } catch (error) { console.error("Erro ao importar:", error); await showGenericModal({type: 'alert', title: 'Erro de Importação', message: `Não foi possível ler o arquivo. Detalhe: ${error.message}`}); } 
                finally { importFileInput.value = ''; }
            };
            reader.onerror = async () => { await showGenericModal({type: 'alert', title: 'Erro', message: 'Não foi possível ler o arquivo.'}); importFileInput.value = ''; };
            reader.readAsBinaryString(file);
        };
        const openAiModal = () => { aiInitialState.classList.remove('hidden'); aiLoadingState.classList.add('hidden'); aiResultState.classList.add('hidden'); aiResultState.innerHTML = ''; aiModal.classList.remove('hidden'); };
        const closeAiModal = () => aiModal.classList.add('hidden');
        const simpleMarkdownToHtml = (markdown) => markdown.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h3>$1</h3>').replace(/^# (.*$)/gim, '<h3>$1</h3>').replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>').replace(/<\/ul>\s?<ul>/g, '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        const analyzeFinancesWithAI = async () => {
            aiInitialState.classList.add('hidden'); aiLoadingState.classList.remove('hidden');
            try {
                const threeMonthsAgo = new Date(); threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const recentTransactions = transactions.filter(t => new Date(t.date) >= threeMonthsAgo && t.status === 'completed');
                if (recentTransactions.length < 5) { aiResultState.innerHTML = '<p>Dados insuficientes para uma análise. Adicione mais transações.</p>'; aiLoadingState.classList.add('hidden'); aiResultState.classList.remove('hidden'); return; }
                const income = recentTransactions.filter(t => t.type === 'entrada').reduce((s, t) => s + t.amount, 0);
                const expenses = recentTransactions.filter(t => t.type === 'saida').reduce((s, t) => s + t.amount, 0);
                const expensesByCategory = recentTransactions.filter(t => t.type === 'saida').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
                const expenseSummary = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a).slice(0, 5).map(([cat, val]) => `  - ${cat}: ${formatCurrency(val)} (Orçamento: ${settings.budgets[cat] ? formatCurrency(settings.budgets[cat]) : 'Não definido'})`).join('\n');
                const userPrompt = `Analise meus dados financeiros dos últimos 3 meses:\n- Renda Total: ${formatCurrency(income)}\n- Despesas Totais: ${formatCurrency(expenses)}\n- Principais Categorias de Despesa:\n${expenseSummary}\n- Meta de economia mensal: ${formatCurrency(settings.savingsGoal)}\n- Saldo médio mensal: ${formatCurrency((income - expenses) / 3)}\n\nCom base nisso, quais os principais insights e o que posso fazer para melhorar?`;
                const systemPrompt = "Você é um analista financeiro. Analise os dados e forneça insights e dicas práticas em português do Brasil. Seja claro, objetivo e encorajador. Formate a resposta usando markdown com títulos (###), listas (*) e negrito (**). Comece com 'Resumo Geral', depois 'Pontos Positivos', 'Pontos de Atenção/Melhora' e, por fim, 'Sugestões Práticas'.";
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) { aiResultState.innerHTML = simpleMarkdownToHtml(text); } else { throw new Error("A resposta da IA está vazia."); }
            } catch (error) { console.error("Erro na IA:", error); aiResultState.innerHTML = `<p class="text-red-600">Ocorreu um erro. Tente novamente.</p><p class="text-xs text-gray-500 mt-2">${error.message}</p>`; } 
            finally { aiLoadingState.classList.add('hidden'); aiResultState.classList.remove('hidden'); }
        };
        const openDebtManagementModal = () => { renderDebtManagementList(); debtManagementModal.classList.remove('hidden'); };
        const closeDebtManagementModal = () => debtManagementModal.classList.add('hidden');
        
        const openAddEditDebtModal = (debtId = null) => {
            debtForm.reset();
            debtForm.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
            document.getElementById('debt-form-error-message').classList.add('hidden');
            editingDebtId = debtId;
            
            const fields = ['debt-description', 'debt-total-amount', 'debt-down-payment', 'debt-installments-count', 'debt-interest-rate', 'debt-interest-period', 'debt-start-date'];
            fields.forEach(id => { document.getElementById(id).disabled = false; });
            debtForm.querySelectorAll('input[name="amortization-type"]').forEach(radio => radio.disabled = false);

            if(debtId){
                const debt = debts.find(d => d.id === debtId);
                if(!debt) return;
                
                addEditDebtModalTitle.textContent = "Editar Dívida";
                debtForm.querySelector('button[type="submit"]').textContent = "Salvar Alterações (Recalcular)";
                
                document.getElementById('debt-description').value = debt.description;
                document.getElementById('debt-total-amount').value = debt.totalAmount;
                document.getElementById('debt-down-payment').value = debt.downPayment;
                document.getElementById('debt-installments-count').value = debt.installmentsCount;
                document.getElementById('debt-start-date').value = debt.startDate;
                document.getElementById('debt-interest-rate').value = (debt.interestRate * 100).toFixed(2);
                document.getElementById('debt-interest-period').value = debt.interestPeriod || 'monthly';
                debtForm.querySelector(`input[name="amortization-type"][value="${debt.amortizationType}"]`).checked = true;

            } else {
                addEditDebtModalTitle.textContent = "Nova Dívida";
                debtForm.querySelector('button[type="submit"]').textContent = "Salvar Dívida";
                fields.forEach(id => { document.getElementById(id).value = ''; });
                debtForm.querySelector('input[name="amortization-type"][value="PRICE"]').checked = true;
            }
            addEditDebtModal.classList.remove('hidden');
        };
        
        const closeAddEditDebtModal = () => addEditDebtModal.classList.add('hidden');
        const openDebtDetailsModal = (debtId) => { viewingDebtId = debtId; renderDebtDetailsModal(); debtDetailsModal.classList.remove('hidden'); };
        const closeDebtDetailsModal = () => debtDetailsModal.classList.add('hidden');
        
        const renderDebtManagementList = () => {
            if (debts.length === 0) { debtListContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma dívida cadastrada.</p>'; return; }
            debtListContainer.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Descrição</th><th class="px-4 py-3 text-right">Saldo Devedor</th><th class="px-4 py-3 text-right">Próxima Parcela</th><th class="px-4 py-3 text-center">Ações</th></tr></thead><tbody>${debts.map(debt => { const remainingPrincipal=debt.installments.filter(p=>p.status==='pending').reduce((s,p)=>s+p.principal,0); const nextInstallment=debt.installments.find(p=>p.status==='pending'); return `<tr class="border-b hover:bg-gray-50" data-id="${debt.id}" title="Clique para ver detalhes"><td class="px-4 py-3 font-medium text-gray-900">${debt.description}</td><td class="px-4 py-3 text-right font-semibold">${formatCurrency(remainingPrincipal)}</td><td class="px-4 py-3 text-right">${nextInstallment?`${formatCurrency(nextInstallment.value)} em ${formatDate(nextInstallment.dueDate)}`:'Quitada'}</td><td class="px-4 py-3 flex justify-center items-center space-x-2"><button data-action="edit-debt" data-id="${debt.id}" class="font-medium text-blue-600 hover:underline p-1">Editar</button><button data-action="delete-debt" data-id="${debt.id}" class="font-medium text-red-600 hover:underline p-1">Excluir</button></td></tr>`; }).join('')}</tbody></table></div>`;
        };
        const renderDebtDetailsModal = () => {
            const debt = debts.find(d => d.id === viewingDebtId);
            if (!debt) return;
            debtDetailsModalTitle.textContent = debt.description;
            const paidInstallments = debt.installments.filter(p => p.status === 'paid');
            const totalPaid = paidInstallments.reduce((sum, p) => sum + p.value, 0);
            const remainingPrincipal = debt.installments.filter(p => p.status === 'pending').reduce((s, p) => s + p.principal, 0);
            const totalInterest = debt.installments.reduce((sum, p) => sum + p.interest, 0);
            debtSummaryContainer.innerHTML = `<div><p class="text-sm text-gray-500">Valor Total</p><p class="text-lg font-bold">${formatCurrency(debt.totalAmount)}</p></div><div><p class="text-sm text-gray-500">Total Pago</p><p class="text-lg font-bold text-green-600">${formatCurrency(totalPaid)}</p></div><div><p class="text-sm text-gray-500">Saldo Devedor</p><p class="text-lg font-bold text-red-600">${formatCurrency(remainingPrincipal)}</p></div><div><p class="text-sm text-gray-500">Total Juros</p><p class="text-lg font-bold">${formatCurrency(totalInterest)}</p></div>`;
            const tableHeader = `<thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr><th class="px-4 py-2 text-center">#</th><th class="px-4 py-2">Vencimento</th><th class="px-4 py-2 text-right">Parcela</th><th class="px-4 py-2 text-right">Juros</th><th class="px-4 py-2 text-right">Amortização</th><th class="px-4 py-2 text-right">Saldo Devedor</th><th class="px-4 py-2 text-center">Status</th></tr></thead>`;
            const tableBody = debt.installments.map(p => `<tr class="border-b ${p.status === 'paid' ? 'bg-green-50' : 'bg-white'}"><td class="px-4 py-2 text-center font-medium ${p.status==='paid'?'installment-paid':''}">${p.number}</td><td class="px-4 py-2 ${p.status==='paid'?'installment-paid':''}">${formatDate(p.dueDate)}</td><td class="px-4 py-2 text-right font-semibold ${p.status==='paid'?'installment-paid':''}">${formatCurrency(p.value)}</td><td class="px-4 py-2 text-right ${p.status==='paid'?'installment-paid':''}">${formatCurrency(p.interest)}</td><td class="px-4 py-2 text-right ${p.status==='paid'?'installment-paid':''}">${formatCurrency(p.principal)}</td><td class="px-4 py-2 text-right ${p.status==='paid'?'installment-paid':''}">${formatCurrency(p.remainingBalance)}</td><td class="px-4 py-2 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${p.status==='paid'?'bg-green-200 text-green-800':'bg-yellow-200 text-yellow-800'}">${p.status==='paid'?'Pago':'Pendente'}</span></td></tr>`).join('');
            debtAmortizationTableContainer.innerHTML = `<table class="w-full text-sm">${tableHeader}<tbody>${tableBody}</tbody></table>`;
            document.getElementById('prepayment-amount').value = '';
            prepaymentSimulationResult.classList.add('hidden');
            prepaymentSimulationResult.innerHTML = '';
        };
        const calculateAmortization = (principal, term, monthlyRate, type) => {
            const installments = [];
            let remainingBalance = principal;
            if (type === 'PRICE') {
                if (monthlyRate === 0) { const installmentValue = principal / term; for (let i = 1; i <= term; i++) { remainingBalance -= installmentValue; installments.push({ number: i, value: installmentValue, interest: 0, principal: installmentValue, remainingBalance: remainingBalance < 0.01 ? 0 : remainingBalance }); } }
                else { const i=monthlyRate,n=term; const installmentValue=principal*(i*Math.pow(1+i,n))/(Math.pow(1+i,n)-1); for(let k=1;k<=n;k++){const interest=remainingBalance*i;const principalPaid=installmentValue-interest;remainingBalance-=principalPaid;installments.push({number:k,value:installmentValue,interest:interest,principal:principalPaid,remainingBalance:remainingBalance<0.01?0:remainingBalance})} }
            } else if (type === 'SAC') {
                const principalAmortization = principal / term;
                for(let i=1;i<=term;i++){const interest=remainingBalance*monthlyRate;const installmentValue=principalAmortization+interest;remainingBalance-=principalAmortization;installments.push({number:i,value:installmentValue,interest:interest,principal:principalAmortization,remainingBalance:remainingBalance<0.01?0:remainingBalance})}
            }
            return installments;
        };
        const validateDebtForm = () => {
            const errors=[];let isValid=true;const form=document.getElementById('debt-form');form.querySelectorAll('.invalid-field').forEach(el=>el.classList.remove('invalid-field'));
            const getVal=id=>document.getElementById(id).value;const getNum=id=>parseFloat(getVal(id))||0;
            if(!getVal('debt-description')){errors.push('A descrição é obrigatória.');document.getElementById('debt-description').classList.add('invalid-field');isValid=false}
            if(getNum('debt-total-amount')<=0){errors.push('O valor total deve ser maior que zero.');document.getElementById('debt-total-amount').classList.add('invalid-field');isValid=false}
            if(getNum('debt-installments-count')<=0){errors.push('O nº de parcelas deve ser maior que zero.');document.getElementById('debt-installments-count').classList.add('invalid-field');isValid=false}
            if(!getVal('debt-start-date')){errors.push('A data da 1ª parcela é obrigatória.');document.getElementById('debt-start-date').classList.add('invalid-field');isValid=false}
            if(getNum('debt-total-amount')<=getNum('debt-down-payment')){errors.push('A entrada não pode ser maior/igual ao valor total.');document.getElementById('debt-down-payment').classList.add('invalid-field');isValid=false}
            if(!isValid){debtFormErrorMessage.innerHTML=errors.join('<br>');debtFormErrorMessage.classList.remove('hidden')}else{debtFormErrorMessage.classList.add('hidden')}
            return isValid;
        };
        const handleDebtDeletion = async (debtId) => {
            const confirmed = await showGenericModal({type:'confirm',title:'Excluir Dívida',message:'Tem certeza? Todas as parcelas e a entrada associada serão removidas permanentemente.'});
            if (confirmed) {
                debts = debts.filter(d => d.id !== debtId);
                transactions = transactions.filter(t => t.debtId !== debtId);
                await saveData(); 
                updateDashboard(); 
                renderDebtManagementList();
            }
        };
        
        // --- Event Listeners ---
        addTransactionBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        transactionModal.addEventListener('click', (e) => { if (e.target === transactionModal) closeModal(); });
        isFixedCheckbox.addEventListener('change', () => { 
            const isChecked = isFixedCheckbox.checked;
            isVariableContainer.classList.toggle('hidden', !isChecked);
            recurrencePeriodContainer.classList.toggle('hidden', !isChecked);
            recurrenceCountContainer.classList.toggle('hidden', !isChecked);
        });
        categorySelect.addEventListener('change', populateSubcategories);
        toggleVisibilityBtns.forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); toggleValuesVisibility(); }));
        closeTransactionsModalBtn.addEventListener('click', closeTransactionsModal);
        transactionsModal.addEventListener('click', (e) => { if (e.target === transactionsModal) closeTransactionsModal(); });
        exportBtn.addEventListener('click', exportFilteredDataToXLSX);
        forecastBtn.addEventListener('click', openForecastModal);
        closeForecastModalBtn.addEventListener('click', closeForecastModal);
        forecastModal.addEventListener('click', (e) => { if (e.target === forecastModal) closeForecastModal(); });
        exportForecastBtn.addEventListener('click', exportForecastDataToXLSX);
        downloadTemplateBtn.addEventListener('click', downloadTemplateXLSX);
        exportAllBtn.addEventListener('click', exportAllDataToXLSX);
        importAllBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => { if (e.target.files[0]) importDataFromXLSX(e.target.files[0])});
        aiBtn.addEventListener('click', openAiModal);
        closeAiModalBtn.addEventListener('click', closeAiModal);
        aiModal.addEventListener('click', (e) => { if(e.target === aiModal) closeAiModal(); });
        analyzeFinanceBtn.addEventListener('click', analyzeFinancesWithAI);
        prevMonthBtn.addEventListener('click', () => { currentPendingDate.setMonth(currentPendingDate.getMonth() - 1); updateDashboard(); });
        nextMonthBtn.addEventListener('click', () => { currentPendingDate.setMonth(currentPendingDate.getMonth() + 1); updateDashboard(); });
        transactionTypeBtns.forEach(btn => btn.addEventListener('click', () => { transactionTypeBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); selectedTransactionType = btn.dataset.type; updateFormForType(selectedTransactionType); }));
        
        prevInvoiceBtn.addEventListener('click', () => { if (invoiceMonthOffset > 0) { invoiceMonthOffset--; updateDashboard(); } });
        nextInvoiceBtn.addEventListener('click', () => { invoiceMonthOffset++; updateDashboard(); });

        cards.forEach(card => card.addEventListener('click', (e) => {
            if (e.target.closest('#prev-invoice-btn') || e.target.closest('#next-invoice-btn')) {
                return;
            }
            const cardType = card.dataset.cardType;
            switch (cardType) {
                case 'balance': openTransactionsModal({ cardType: 'balance', title: 'Extrato Completo', transactions: transactions.filter(t => t.status === 'completed'), filters: ['period', 'type', 'category', 'subcategory'] }); break;
                case 'investments': openTransactionsModal({ cardType: 'investments', title: 'Total Investido', transactions: transactions.filter(t => t.status === 'completed' && t.type === 'investimento'), filters: [] }); break;
                case 'invoice': 
                    const { startDate, endDate } = getInvoicePeriod(invoiceMonthOffset);
                    const invoiceTransactions = transactions.filter(t => {
                        if (t.status !== 'completed' || t['payment-method'] !== 'Cartão de Crédito') return false;
                        const tDate = new Date(t.date + 'T00:00:00');
                        return tDate >= startDate && tDate <= endDate;
                    });
                    const title = `Fatura (Fecha em ${endDate.toLocaleDateString('pt-BR')})`;
                    openTransactionsModal({ cardType: 'invoice', title: title, transactions: invoiceTransactions, filters: [] }); 
                    break;
                case 'debts': openDebtManagementModal(); break;
            }
        }));
        
        const addOverviewCardListeners = () => {
            const getMonthTransactions = () => {
                const currentMonth = currentPendingDate.getMonth();
                const currentYear = currentPendingDate.getFullYear();
                return transactions.filter(t => {
                    const tDate = new Date(t.date + 'T00:00:00');
                    return t.status === 'completed' && tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
                });
            };

            overviewIncomeCard.addEventListener('click', () => {
                const monthTransactions = getMonthTransactions();
                const incomeTransactions = monthTransactions.filter(t => t.type === 'entrada');
                const monthName = pendingMonthDisplay.textContent;
                openTransactionsModal({
                    cardType: 'overview-income',
                    title: `Entradas de ${monthName}`,
                    transactions: incomeTransactions,
                    filters: ['category', 'subcategory']
                });
            });

            overviewExpensesCard.addEventListener('click', () => {
                const monthTransactions = getMonthTransactions();
                const expenseTransactions = monthTransactions.filter(t => t.type === 'saida');
                const monthName = pendingMonthDisplay.textContent;
                openTransactionsModal({
                    cardType: 'overview-expenses',
                    title: `Saídas de ${monthName}`,
                    transactions: expenseTransactions,
                    filters: ['category', 'subcategory']
                });
            });

            overviewBalanceCard.addEventListener('click', () => {
                const monthTransactions = getMonthTransactions().filter(t => t.type === 'entrada' || t.type === 'saida');
                const monthName = pendingMonthDisplay.textContent;
                openTransactionsModal({
                    cardType: 'overview-balance',
                    title: `Extrato de ${monthName}`,
                    transactions: monthTransactions,
                    filters: ['type', 'category', 'subcategory']
                });
            });
        };
        addOverviewCardListeners();

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateForm()) return;
            const transactionData = {
                type: selectedTransactionType,
                amount: parseFloat(amountInput.value),
                date: dateInput.value,
                category: categorySelect.value,
                subcategory: subcategorySelect.value || "",
                'payment-method': paymentMethodSelect.value || "",
                description: document.getElementById('description').value || ""
            };
            try {
                if (editingTransactionId) {
                    const transactionIndex = transactions.findIndex(t => t.id === editingTransactionId);
                    if (transactionIndex > -1) {
                        transactions[transactionIndex] = { ...transactions[transactionIndex], ...transactionData };
                    }
                } else {
                    const isFixed = isFixedCheckbox.checked;
                    transactionData.isFixed = isFixed;
                    transactionData.isVariable = isFixed ? document.getElementById('is-variable').checked : false;
                    transactionData.recurrencePeriod = isFixed ? document.getElementById('recurrence-period').value : null;

                    if (isFixed) {
                        const templateBase = { ...transactionData };
                        delete templateBase.date;
                        templateBase.id = `template-${Date.now()}`;
                        
                        const customCount = parseInt(document.getElementById('recurrence-count').value, 10);
                        templateBase.recurrenceCount = customCount > 0 ? customCount : null;
                        
                        fixedTransactionTemplates.push(templateBase);

                        const startDate = new Date(transactionData.date + 'T12:00:00Z');
                        const period = transactionData.recurrencePeriod;
                        
                        let iterations;
                        if (customCount && customCount > 0) {
                            iterations = customCount;
                        } else {
                            if (period === 'daily') iterations = 90;
                            else if (period === 'weekly') iterations = 104; 
                            else if (period === 'yearly') iterations = 5;
                            else iterations = 24; 
                        }
                        
                        for (let i = 0; i < iterations; i++) {
                            const nextDate = new Date(startDate.getTime());
                            switch (period) {
                                case 'daily': nextDate.setUTCDate(startDate.getUTCDate() + i); break;
                                case 'weekly': nextDate.setUTCDate(startDate.getUTCDate() + (i * 7)); break;
                                case 'yearly': nextDate.setUTCFullYear(startDate.getUTCFullYear() + i); break;
                                case 'monthly': default:
                                    nextDate.setUTCMonth(startDate.getUTCMonth() + i);
                                    if (nextDate.getUTCDate() !== startDate.getUTCDate()) {
                                        nextDate.setUTCDate(0);
                                    }
                                    break;
                            }
                            const newInstance = { 
                                ...transactionData, 
                                id: Date.now() + i, 
                                templateId: templateBase.id, 
                                status: 'pending',
                                date: nextDate.toISOString().split('T')[0]
                            };
                            transactions.push(newInstance);
                        }
                    } else {
                        transactions.push({ ...transactionData, id: Date.now(), status: 'completed' });
                    }
                }
                await saveData();
                updateDashboard();
                closeModal();
            } catch (error) {
                console.error("Erro ao salvar transação:", error);
                showGenericModal({type: 'alert', title: 'Erro', message: 'Não foi possível salvar a transação. Tente novamente.'});
            }
        });

        settingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            settings.invoiceClosingDay = parseInt(invoiceClosingDayInput.value) || 1;
            settings.savingsGoal = parseFloat(savingsGoalInput.value) || 0;
            document.querySelectorAll('input[data-budget-category]').forEach(input => { const category = input.dataset.budgetCategory; const value = parseFloat(input.value); if (value > 0) { settings.budgets[category] = value; } else { delete settings.budgets[category]; } });
            await saveData();
            updateDashboard();
            await showGenericModal({ type: 'alert', title: 'Sucesso', message: 'Configurações salvas!'});
            closeSettingsModal();
        });
        budgetBarsContainer.addEventListener('click', (e) => {
            const regularizeButton = e.target.closest('button[data-action="regularize"]');
            if(regularizeButton) { e.stopPropagation(); openSettingsModal(); return; }
            const bar = e.target.closest('.budget-bar-container');
            if (!bar || !bar.dataset.category) return;
            const category = bar.dataset.category;
            const currentMonth = currentPendingDate.getMonth(), currentYear = currentPendingDate.getFullYear();
            const transactionsForCategory = transactions.filter(t => { const tDate=new Date(t.date+'T00:00:00'); return t.category===category&&tDate.getMonth()===currentMonth&&tDate.getFullYear()===currentYear; });
            openTransactionsModal({ title: `Lançamentos de ${category}`, transactions: transactionsForCategory, filters: ['subcategory'] });
        });
        
        transactionsModalList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('button[data-action="delete-transaction"]');
            const row = e.target.closest('tr[data-id]');

            if (deleteButton) {
                const transactionId = parseInt(deleteButton.dataset.id);
                const transactionIndex = transactions.findIndex(t => t.id === transactionId);
                if (transactionIndex === -1) return;

                const transaction = transactions[transactionIndex];
                
                let confirmed = false;
                if (transaction.debtId) {
                    if(transaction.subcategory === 'Entrada Financiamento') {
                        await showGenericModal({ type: 'alert', title: 'Ação Bloqueada', message: 'A entrada de um financiamento não pode ser excluída. Para corrigir, exclua a dívida inteira na tela de "Gerenciar Dívidas".' });
                        return;
                    }
                    confirmed = await showGenericModal({ type: 'confirm', title: 'Excluir Pagamento de Dívida', message: 'Este é um pagamento de dívida. Excluí-lo marcará a parcela como "pendente" novamente. Deseja continuar?' });
                } else {
                    confirmed = await showGenericModal({ type: 'confirm', title: 'Excluir Transação', message: 'Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.' });
                }

                if (confirmed) {
                    if (transaction.debtId && transaction.installmentNumber) {
                        const debt = debts.find(d => d.id === transaction.debtId);
                        if (debt) {
                            const installment = debt.installments.find(p => p.number === transaction.installmentNumber);
                            if (installment) {
                                installment.status = 'pending';
                            }
                        }
                    }

                    transactions.splice(transactionIndex, 1);
                    modalTransactionData = modalTransactionData.filter(t => t.id !== transactionId);

                    await saveData();
                    updateDashboard();
                    applyFiltersAndRender(modalTransactionData, 'balance');
                }
            } else if (row) {
                const transactionId = parseInt(row.dataset.id);
                openModalForEdit(transactionId);
            }
        });

        categoryManagementContainer.addEventListener('click', handleCategoryManagementAction);
        categoryManagementContainer.addEventListener('change', handleCategoryManagementAction);
        
        viewPendingBtn.addEventListener('click', () => {
            renderPendingModalList();
            pendingTransactionsModal.classList.remove('hidden');
        });
        closePendingModalBtn.addEventListener('click', () => pendingTransactionsModal.classList.add('hidden'));
        pendingTransactionsModal.addEventListener('click', (e) => {
            if (e.target === pendingTransactionsModal) pendingTransactionsModal.classList.add('hidden');
        });
        pendingModalList.addEventListener('click', handlePendingAction);
        
        closeDebtManagementModalBtn.addEventListener('click', closeDebtManagementModal);
        debtManagementModal.addEventListener('click', (e) => { if(e.target === debtManagementModal) closeDebtManagementModal() });
        addNewDebtBtn.addEventListener('click', () => {
            closeDebtManagementModal();
            openAddEditDebtModal();
        });
        closeAddEditDebtModalBtn.addEventListener('click', closeAddEditDebtModal);
        addEditDebtModal.addEventListener('click', (e) => { if(e.target === addEditDebtModal) closeAddEditDebtModal() });
        closeDebtDetailsModalBtn.addEventListener('click', closeDebtDetailsModal);
        debtDetailsModal.addEventListener('click', (e) => { if(e.target === debtDetailsModal) closeDebtDetailsModal() });
        
        debtListContainer.addEventListener('click', (e) => {
            const row = e.target.closest('tr[data-id]');
            const deleteBtn = e.target.closest('button[data-action="delete-debt"]');
            const editBtn = e.target.closest('button[data-action="edit-debt"]');

            if (deleteBtn) {
                e.stopPropagation();
                const debtId = parseInt(deleteBtn.dataset.id);
                handleDebtDeletion(debtId);
            } else if (editBtn) {
                e.stopPropagation();
                const debtId = parseInt(editBtn.dataset.id);
                closeDebtManagementModal(); 
                openAddEditDebtModal(debtId); 
            } else if (row) {
                const debtId = parseInt(row.dataset.id);
                openDebtDetailsModal(debtId);
            }
        });
        
        debtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateDebtForm()) return;

            if (editingDebtId) {
                const confirmed = await showGenericModal({ type: 'confirm', title: 'Recalcular Dívida', message: 'Você está editando os dados financeiros de uma dívida. Isso irá apagar a dívida antiga e todas as suas parcelas, criando uma nova com os valores informados. Deseja continuar?' });
                if (!confirmed) return;
                
                debts = debts.filter(d => d.id !== editingDebtId);
                transactions = transactions.filter(t => t.debtId !== editingDebtId);
                editingDebtId = null; 
            }

            const totalAmount = parseFloat(document.getElementById('debt-total-amount').value);
            const downPayment = parseFloat(document.getElementById('debt-down-payment').value) || 0;
            const principal = totalAmount - downPayment;
            const term = parseInt(document.getElementById('debt-installments-count').value);
            const rate = (parseFloat(document.getElementById('debt-interest-rate').value) || 0) / 100;
            const ratePeriod = document.getElementById('debt-interest-period').value;
            const startDate = document.getElementById('debt-start-date').value;
            const amortizationType = debtForm.querySelector('input[name="amortization-type"]:checked').value;
            const description = document.getElementById('debt-description').value;
            const monthlyRate = ratePeriod === 'yearly' && rate > 0 ? Math.pow(1 + rate, 1 / 12) - 1 : rate;
            const installments = calculateAmortization(principal, term, monthlyRate, amortizationType);
            const newDebtId = Date.now();
            const newDebt = { id: newDebtId, description, totalAmount, downPayment, financedAmount: principal, installmentsCount: term, interestRate: monthlyRate, interestPeriod: 'monthly', startDate, amortizationType, installments: [] };
            const firstInstallmentDate = new Date(startDate + 'T12:00:00Z');
            
            installments.forEach((inst, index) => {
                const installmentDate = new Date(firstInstallmentDate.getTime());
                installmentDate.setUTCMonth(installmentDate.getUTCMonth() + index);
                const dueDate = installmentDate.toISOString().split('T')[0];
                newDebt.installments.push({ ...inst, dueDate, status: 'pending' });
                transactions.push({ id: Date.now() + index, debtId: newDebtId, description: `${description} - Parcela ${inst.number}/${term}`, amount: inst.value, date: dueDate, type: 'saida', category: 'Dívidas', subcategory: 'Parcela Financiamento', status: 'pending', isFixed: true, isVariable: false, installmentNumber: inst.number, installmentsTotal: term });
            });
            
            if (downPayment > 0) {
                transactions.push({ id: Date.now() - 1, debtId: newDebtId, description: `Entrada: ${description}`, amount: downPayment, date: startDate, type: 'saida', category: 'Dívidas', subcategory: 'Entrada Financiamento', status: 'completed', isFixed: false, isVariable: false });
            }
            
            debts.push(newDebt);
            
            await saveData();
            updateDashboard();
            closeAddEditDebtModal();
            renderDebtManagementList();
        });
    });
    </script>
</body>
</html>
